<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Ruta - Te lleva</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            background: #f4f6fb;
        }
        header {
            background: #ff6600;
            color: #fff;
            padding: 1.5rem 0;
            text-align: center;
            font-size: 2rem;
            letter-spacing: 1px;
            font-weight: bold;
        }
        .search-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .search-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .search-info p {
            margin: 0;
            line-height: 1.4;
        }
        
        .category-selector {
            margin-bottom: 1.5rem;
        }
        
        .category-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .category-select:focus {
            outline: none;
            border-color: #6b46c1;
            box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.1);
        }
        
        .category-select option {
            padding: 0.5rem;
        }
        .search-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: flex-end;
        }
        .search-row .search-button {
            height: 48px;
            min-width: 110px;
            margin-bottom: 0;
            align-self: flex-end;
            font-size: 1rem;
            padding: 0 1.5rem;
            white-space: nowrap;
        }
        @media (max-width: 600px) {
            .search-row {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            .search-row .search-button {
                width: 100%;
                min-width: unset;
                height: 44px;
                margin-left: 0;
            }
        }
        .input-container {
            position: relative;
            flex: 1;
        }
        .search-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        .search-input:focus {
            outline: none;
            border-color: #6b46c1;
            box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.1);
        }
        .search-button {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #6b46c1, #553c9a);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 70, 193, 0.3);
        }
        .or-divider {
            text-align: center;
            margin: 1.5rem 0;
            color: #718096;
            font-weight: 500;
            position: relative;
        }
        .or-divider::before,
        .or-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #e2e8f0;
        }
        .or-divider::before {
            left: 0;
        }
        .or-divider::after {
            right: 0;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .btn-primary, .btn-secondary {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6b46c1, #553c9a);
            color: white;
        }
        .btn-secondary {
            background: white;
            color: #6b46c1;
            border: 2px solid #6b46c1;
        }
        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 70, 193, 0.2);
        }
        .info {
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(107, 70, 193, 0.1);
            border-radius: 12px;
            color: #553c9a;
            font-weight: 500;
        }
        .legend {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin: 2rem 0;
        }
        
        .legend h3 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .legend ul {
            list-style: none;
            padding: 0;
        }
        
        .legend li {
            margin-bottom: 0.5rem;
            color: #4a5568;
        }
        
        /* Estilos para contenedores lado a lado */
        .info-containers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .stats-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 16px;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .stats-container h3 {
            margin: 0 0 1.5rem 0;
            font-size: 1.5rem;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .stats-info {
            font-size: 0.9rem;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        @media (max-width: 768px) {
            .info-containers {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f7fafc;
            transition: background-color 0.2s ease;
        }
        .suggestion-item:hover {
            background-color: #f7fafc;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        #map {
            width: 100vw;
            height: 60vh;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin: 1.5rem 0;
        }
        .controls button {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #ff6600;
            color: #fff;
        }
        .btn-primary:hover {
            background: #e65c00;
        }
        .btn-secondary {
            background: #6c757d;
            color: #fff;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .info {
            text-align: center;
            margin-bottom: 1rem;
            color: #333;
            padding: 1rem;
            background: #fff;
            border-radius: 5px;
            margin: 1rem;
        }
        .legend {
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            max-width: 350px;
            margin: 2rem auto;
        }
        .legend h3 {
            margin-top: 0;
            color: #ff6600;
        }
        .legend ul {
            padding-left: 1.2rem;
        }
        .suggestions {
            position: absolute;
            background: #fff;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .suggestion-item {
            padding: 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .suggestion-item:hover {
            background: #f8f9fa;
        }
        .input-container {
            position: relative;
            flex: 1;
        }
        
        @media (max-width: 600px) {
            #map { height: 50vh; }
            .search-row { flex-direction: column; }
        }
        
        /* Estilos para la sección de rutas detalladas */
        .routes-detail-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 4rem 2rem;
            margin-top: 2rem;
        }
        
        .routes-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .routes-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 300;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        .routes-subtitle {
            text-align: center;
            color: #718096;
            font-size: 1.1rem;
            margin-bottom: 3rem;
        }
        
        .route-category {
            margin-bottom: 3rem;
        }
        
        .category-title {
            font-size: 1.8rem;
            font-weight: 400;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .route-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .route-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        .route-header {
            padding: 1.5rem;
            color: white;
        }
        
        .route-header h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.3rem;
            font-weight: 500;
        }
        
        .route-info {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .route-stations {
            padding: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        .station-item {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 400;
            color: white;
            transition: transform 0.2s ease;
        }
        
        .station-item:hover {
            transform: scale(1.05);
        }
        
        .station-item.portal {
            background: #ff6600;
        }
        
        .station-item.troncal {
            background: #0074D9;
        }
        
        .station-item.pretroncal {
            background: #2ECC40;
        }
        
        .station-item.alimentadora {
            background: #FF4136;
        }
        
        .station-item.complementaria {
            background: #FF851B;
        }
        
        .route-footer {
            padding: 1rem 1.5rem;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        .route-footer span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .routes-detail-section {
                padding: 2rem 1rem;
            }
            
            .routes-title {
                font-size: 2rem;
            }
            
            .route-stations {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .route-footer {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
        }
        
        .input-with-button {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .location-btn {
            position: absolute;
            right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .location-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .location-btn:active {
            transform: scale(0.95);
        }
        
        .location-btn.loading {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .search-input {
            padding-right: 60px;
        }
        #endInput {
            width: 100%;
            min-width: 180px;
            max-width: 100%;
            box-sizing: border-box;
        }
        @media (max-width: 600px) {
            .search-row {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            .search-row .input-container {
                max-width: 100%;
            }
            #endInput {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header id="headerTitle">Mi Ruta - Cartagena</header>
    
    <div class="search-container">
        <div class="search-info">
            <p><strong>🌍 Área de Cobertura:</strong> Este sistema está optimizado para Cartagena de Indias. Las búsquedas y rutas están limitadas al área metropolitana de la ciudad.</p>
        </div>
        
        <div class="search-controls">
            <h3 style="text-align: center; color: #333; margin-bottom: 1.5rem; font-size: 1.3rem;">Planifica tu Ruta</h3>
            
            <!-- Selector de categorías -->
            <div class="category-selector">
                <label for="searchCategory" style="display: block; margin-bottom: 0.5rem; color: #666; font-size: 0.9rem;">Tipo de búsqueda:</label>
                <select id="searchCategory" class="category-select" onchange="updateSearchPlaceholders()">
                    <option value="all">🔍 Todo (direcciones, restaurantes, hoteles, etc.)</option>
                    <option value="restaurants">🍽️ Restaurantes y Cafés</option>
                    <option value="hotels">🏨 Hoteles y Alojamiento</option>
                    <option value="shops">🛒 Tiendas y Comercios</option>
                    <option value="businesses">🏢 Empresas y Negocios</option>
                    <option value="entertainment">🎭 Entretenimiento</option>
                    <option value="healthcare">🏥 Salud y Farmacias</option>
                    <option value="education">🎓 Educación</option>
                    <option value="transport">🚌 Transporte</option>
                </select>
            </div>
            
            <div class="search-group">
                <label for="startInput" style="display: block; margin-bottom: 0.5rem; color: #6b46c1; font-size: 0.95rem; font-weight: 600;">Punto de partida</label>
                <div class="input-with-button">
                    <input type="text" id="startInput" class="search-input" placeholder="Escribe tu punto de partida...">
                    <button id="updateLocationBtn" class="location-btn" title="Usar ubicación actual">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
                <div id="startSuggestions" class="suggestions"></div>
            </div>
            
            <div class="search-row">
                <div class="input-container" style="flex: 1;">
                    <label for="endInput" style="display: block; margin-bottom: 0.5rem; color: #6b46c1; font-size: 0.95rem; font-weight: 600;">Punto Destino</label>
                    <input type="text" id="endInput" class="search-input" placeholder="Escribe tu destino...">
                    <div id="endSuggestions" class="suggestions" style="display: none;"></div>
                </div>
                <button class="search-button" onclick="searchLocation('end')">Buscar</button>
            </div>
            <div class="or-divider">O</div>
            <div class="controls" style="justify-content: center; gap: 1rem;">
                <button id="setStart" class="btn-secondary">Seleccionar en mapa (Origen)</button>
                <button id="setEnd" class="btn-secondary">Seleccionar en mapa (Destino)</button>
            </div>
        </div>
    </div>
    
    <div class="controls" style="justify-content: center; gap: 1rem;">
        <button id="startRoute" class="btn-primary">Iniciar recorrido</button>
        <button id="clearRoute" class="btn-secondary">Limpiar ruta</button>
    </div>
    
    <div class="info" id="info">Escribe las direcciones, nombres de restaurantes, hoteles, tiendas o negocios, o selecciónalas en el mapa.</div>
    <div id="map"></div>
    
    <!-- Contenedores lado a lado -->
    <div class="info-containers">
        <div class="legend">
            <h3>Rutas Oficiales de Transcaribe</h3>
            <ul>
                <li><span style="color:#0074D9;">●</span> <strong>Rutas Troncales:</strong> T100E, T101, T102, T103</li>
                <li><span style="color:#2ECC40;">●</span> <strong>Rutas Pretroncales:</strong> X101, X102, X103, X104, X105, X106</li>
                <li><span style="color:#FF4136;">●</span> <strong>Rutas Alimentadoras:</strong> A101, A102, A103, A104, A105, A107, A108, A111, A114, A117</li>
                <li><span style="color:#FF851B;">●</span> <strong>Rutas Complementarias:</strong> C001, C017, C018</li>
            </ul>
            
            <h4 style="margin-top: 1.5rem; color: #ff6600;">Tipos de Estaciones:</h4>
            <ul>
                <li><span style="color:#ff6600; font-weight: bold;">P</span> <strong>Portal:</strong> Estación principal de Transcaribe</li>
                <li><span style="color:#0074D9; font-weight: bold;">T</span> <strong>Troncal:</strong> Estaciones de rutas principales</li>
                <li><span style="color:#2ECC40; font-weight: bold;">X</span> <strong>Pretroncal:</strong> Estaciones de rutas secundarias</li>
                <li><span style="color:#FF4136; font-weight: bold;">A</span> <strong>Alimentadora:</strong> Estaciones de rutas alimentadoras</li>
                <li><span style="color:#FF851B; font-weight: bold;">C</span> <strong>Complementaria:</strong> Estaciones de rutas complementarias</li>
                <li><span style="color:#ff6600; font-weight: bold;">U</span> <strong>Tu ubicación:</strong> Marcador de posición actual</li>
            </ul>
            
            <p style="font-size: 0.9em; color: #666; margin-top: 1rem;">
                <em>Información basada en <a href="https://transcaribe.gov.co/" target="_blank">transcaribe.gov.co</a></em>
            </p>
        </div>
        
        <div class="stats-container">
            <h3>📊 Estadísticas del Sistema Transcaribe</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">4</div>
                    <div class="stat-label">Rutas Troncales</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">6</div>
                    <div class="stat-label">Rutas Pretroncales</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">10</div>
                    <div class="stat-label">Rutas Alimentadoras</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">3</div>
                    <div class="stat-label">Rutas Complementarias</div>
                </div>
            </div>
            <div class="stats-info">
                <strong>Horarios de Operación:</strong><br>
                • Rutas Troncales y Pretroncales: 5:00 AM - 11:00 PM<br>
                • Rutas Alimentadoras: 5:00 AM - 11:00 PM<br>
                • Rutas Complementarias: 6:00 AM - 10:00 PM
            </div>
        </div>
    </div>

    <!-- Nueva sección de Rutas Detalladas -->
    <div class="routes-detail-section">
        <div class="routes-container">
            <h2 class="routes-title">Rutas Detalladas de Transcaribe</h2>
            <p class="routes-subtitle">Explora cada ruta con sus estaciones y paraderos específicos</p>
            
            <!-- RUTAS TRONCALES -->
            <div class="route-category">
                <h3 class="category-title" style="color: #0074D9;">🚌 Rutas Troncales</h3>
                
                <!-- T100E -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #0074D9, #0056b3);">
                        <h4>T100E - Troncal Principal</h4>
                        <span class="route-info">Portal ↔ Centro ↔ Bocagrande</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item portal">Portal de Transcaribe</div>
                        <div class="station-item troncal">Bodeguita</div>
                        <div class="station-item troncal">Centro</div>
                        <div class="station-item troncal">María Auxiliadora</div>
                        <div class="station-item troncal">Cuatro Vientos</div>
                        <div class="station-item troncal">La Castellana</div>
                        <div class="station-item troncal">Madre Bernarda</div>
                        <div class="station-item troncal">Bocagrande</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 5-8 min</span>
                    </div>
                </div>
                
                <!-- T101 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #0074D9, #0056b3);">
                        <h4>T101 - Troncal Norte</h4>
                        <span class="route-info">Portal ↔ Aeropuerto ↔ La Boquilla</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item portal">Portal de Transcaribe</div>
                        <div class="station-item troncal">Crespo</div>
                        <div class="station-item troncal">Aeropuerto Rafael Núñez</div>
                        <div class="station-item troncal">La Boquilla</div>
                        <div class="station-item troncal">Crespo Norte</div>
                        <div class="station-item troncal">Zona Norte</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 8-12 min</span>
                    </div>
                </div>
                
                <!-- T102 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #0074D9, #0056b3);">
                        <h4>T102 - Troncal Sur</h4>
                        <span class="route-info">Portal ↔ El Pozón ↔ Mamonal</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item portal">Portal de Transcaribe</div>
                        <div class="station-item troncal">El Pozón</div>
                        <div class="station-item troncal">Zona Sur</div>
                        <div class="station-item troncal">Mamonal</div>
                        <div class="station-item troncal">Zona Industrial</div>
                        <div class="station-item troncal">Zona Sur Extendida</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 10-15 min</span>
                    </div>
                </div>
                
                <!-- T103 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #0074D9, #0056b3);">
                        <h4>T103 - Troncal Centro</h4>
                        <span class="route-info">Getsemaní ↔ San Diego ↔ Pie de la Popa ↔ Olaya Herrera</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">Getsemaní</div>
                        <div class="station-item troncal">San Diego</div>
                        <div class="station-item troncal">Pie de la Popa</div>
                        <div class="station-item troncal">Olaya Herrera</div>
                        <div class="station-item troncal">Centro Histórico</div>
                        <div class="station-item troncal">Zona Comercial</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 6-10 min</span>
                    </div>
                </div>
            </div>
            
            <!-- RUTAS PRETRONCALES -->
            <div class="route-category">
                <h3 class="category-title" style="color: #2ECC40;">🚐 Rutas Pretroncales</h3>
                
                <!-- X101 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #2ECC40, #27ae60);">
                        <h4>X101 - Pretroncal Norte</h4>
                        <span class="route-info">Portal ↔ Crespo ↔ Aeropuerto</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item portal">Portal de Transcaribe</div>
                        <div class="station-item pretroncal">Crespo</div>
                        <div class="station-item pretroncal">Aeropuerto Rafael Núñez</div>
                        <div class="station-item pretroncal">Crespo Norte</div>
                        <div class="station-item pretroncal">Zona Norte</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 8-12 min</span>
                    </div>
                </div>
                
                <!-- X102 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #2ECC40, #27ae60);">
                        <h4>X102 - Pretroncal Sur</h4>
                        <span class="route-info">Portal ↔ El Pozón ↔ Zona Sur</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item portal">Portal de Transcaribe</div>
                        <div class="station-item pretroncal">El Pozón</div>
                        <div class="station-item pretroncal">Zona Sur</div>
                        <div class="station-item pretroncal">Zona Sur Extendida</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 10-15 min</span>
                    </div>
                </div>
                
                <!-- X103 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #2ECC40, #27ae60);">
                        <h4>X103 - Pretroncal Este</h4>
                        <span class="route-info">Centro ↔ Getsemaní ↔ San Diego</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">Centro</div>
                        <div class="station-item pretroncal">Getsemaní</div>
                        <div class="station-item pretroncal">San Diego</div>
                        <div class="station-item pretroncal">Centro Histórico</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 8-12 min</span>
                    </div>
                </div>
                
                <!-- X104 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #2ECC40, #27ae60);">
                        <h4>X104 - Pretroncal Oeste</h4>
                        <span class="route-info">Centro ↔ Bocagrande ↔ Zona Oeste</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">Centro</div>
                        <div class="station-item pretroncal">Bocagrande</div>
                        <div class="station-item pretroncal">Zona Oeste</div>
                        <div class="station-item pretroncal">Zona Turística</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 8-12 min</span>
                    </div>
                </div>
                
                <!-- X105 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #2ECC40, #27ae60);">
                        <h4>X105 - Pretroncal Central</h4>
                        <span class="route-info">Portal ↔ Pie de la Popa ↔ Olaya Herrera</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item portal">Portal de Transcaribe</div>
                        <div class="station-item pretroncal">Pie de la Popa</div>
                        <div class="station-item pretroncal">Olaya Herrera</div>
                        <div class="station-item pretroncal">Zona Central</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 10-15 min</span>
                    </div>
                </div>
                
                <!-- X106 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #2ECC40, #27ae60);">
                        <h4>X106 - Pretroncal Periférica</h4>
                        <span class="route-info">Pie de la Popa ↔ Olaya Herrera ↔ Zona Periférica</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">Pie de la Popa</div>
                        <div class="station-item pretroncal">Olaya Herrera</div>
                        <div class="station-item pretroncal">Zona Periférica</div>
                        <div class="station-item pretroncal">Zona Periférica Extendida</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 12-18 min</span>
                    </div>
                </div>
            </div>
            
            <!-- RUTAS ALIMENTADORAS -->
            <div class="route-category">
                <h3 class="category-title" style="color: #FF4136;">🚌 Rutas Alimentadoras</h3>
                
                <!-- A101 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #e74c3c);">
                        <h4>A101 - Alimentadora Norte</h4>
                        <span class="route-info">Aeropuerto ↔ Zona Norte</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">Aeropuerto Rafael Núñez</div>
                        <div class="station-item alimentadora">Alimentadora Norte</div>
                        <div class="station-item alimentadora">Zona Norte</div>
                        <div class="station-item alimentadora">Zona Norte Extendida</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 15-20 min</span>
                    </div>
                </div>
                
                <!-- A102 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #e74c3c);">
                        <h4>A102 - Alimentadora Sur</h4>
                        <span class="route-info">El Pozón ↔ Zona Sur</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">El Pozón</div>
                        <div class="station-item alimentadora">Alimentadora Sur</div>
                        <div class="station-item alimentadora">Zona Sur</div>
                        <div class="station-item alimentadora">Zona Sur Extendida</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 15-20 min</span>
                    </div>
                </div>
                
                <!-- A103 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #e74c3c);">
                        <h4>A103 - Alimentadora Este</h4>
                        <span class="route-info">Getsemaní ↔ Zona Este</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">Getsemaní</div>
                        <div class="station-item alimentadora">Alimentadora Este</div>
                        <div class="station-item alimentadora">Zona Este</div>
                        <div class="station-item alimentadora">Zona Este Extendida</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 15-20 min</span>
                    </div>
                </div>
                
                <!-- A104 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #e74c3c);">
                        <h4>A104 - Alimentadora Oeste</h4>
                        <span class="route-info">Bocagrande ↔ Zona Oeste</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">Bocagrande</div>
                        <div class="station-item alimentadora">Alimentadora Oeste</div>
                        <div class="station-item alimentadora">Zona Oeste</div>
                        <div class="station-item alimentadora">Zona Oeste Extendida</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 15-20 min</span>
                    </div>
                </div>
                
                <!-- A105 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #e74c3c);">
                        <h4>A105 - Alimentadora Central</h4>
                        <span class="route-info">Centro ↔ Zona Central</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">Centro</div>
                        <div class="station-item alimentadora">Alimentadora Central</div>
                        <div class="station-item alimentadora">Zona Central</div>
                        <div class="station-item alimentadora">Zona Central Extendida</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 15-20 min</span>
                    </div>
                </div>
                
                <!-- A107 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #e74c3c);">
                        <h4>A107 - Alimentadora Portal</h4>
                        <span class="route-info">Portal ↔ Zona Portal</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item portal">Portal de Transcaribe</div>
                        <div class="station-item alimentadora">Alimentadora Portal</div>
                        <div class="station-item alimentadora">Zona Portal</div>
                        <div class="station-item alimentadora">Zona Portal Extendida</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 15-20 min</span>
                    </div>
                </div>
                
                <!-- A108 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #e74c3c);">
                        <h4>A108 - Alimentadora Crespo</h4>
                        <span class="route-info">Crespo ↔ Zona Crespo</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item pretroncal">Crespo</div>
                        <div class="station-item alimentadora">Alimentadora Crespo</div>
                        <div class="station-item alimentadora">Zona Crespo</div>
                        <div class="station-item alimentadora">Zona Crespo Extendida</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 15-20 min</span>
                    </div>
                </div>
                
                <!-- A111 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #e74c3c);">
                        <h4>A111 - Alimentadora Mamonal</h4>
                        <span class="route-info">Mamonal ↔ Zona Mamonal</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">Mamonal</div>
                        <div class="station-item alimentadora">Alimentadora Mamonal</div>
                        <div class="station-item alimentadora">Zona Mamonal</div>
                        <div class="station-item alimentadora">Zona Industrial</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 15-20 min</span>
                    </div>
                </div>
                
                <!-- A114 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #e74c3c);">
                        <h4>A114 - Alimentadora La Boquilla</h4>
                        <span class="route-info">La Boquilla ↔ Zona Boquilla</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">La Boquilla</div>
                        <div class="station-item alimentadora">Alimentadora La Boquilla</div>
                        <div class="station-item alimentadora">Zona Boquilla</div>
                        <div class="station-item alimentadora">Zona Pesquera</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 15-20 min</span>
                    </div>
                </div>
                
                <!-- A117 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #e74c3c);">
                        <h4>A117 - Alimentadora Periférica</h4>
                        <span class="route-info">Zona Periférica ↔ Zona Periférica Extendida</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item pretroncal">Zona Periférica</div>
                        <div class="station-item alimentadora">Alimentadora Periférica</div>
                        <div class="station-item alimentadora">Zona Periférica Extendida</div>
                        <div class="station-item alimentadora">Zona Periférica 2</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 5:00 AM - 11:00 PM</span>
                        <span>🕐 Frecuencia: 20-25 min</span>
                    </div>
                </div>
            </div>
            
            <!-- RUTAS COMPLEMENTARIAS -->
            <div class="route-category">
                <h3 class="category-title" style="color: #FF851B;">🚌 Rutas Complementarias</h3>
                
                <!-- C001 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #FF851B, #e67e22);">
                        <h4>C001 - Complementaria Principal</h4>
                        <span class="route-info">Centro ↔ Zona Complementaria</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">Centro</div>
                        <div class="station-item complementaria">Complementaria Principal</div>
                        <div class="station-item complementaria">Zona Complementaria</div>
                        <div class="station-item complementaria">Zona Complementaria Extendida</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 6:00 AM - 10:00 PM</span>
                        <span>🕐 Frecuencia: 20-30 min</span>
                    </div>
                </div>
                
                <!-- C017 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #FF851B, #e67e22);">
                        <h4>C017 - Complementaria Norte</h4>
                        <span class="route-info">Aeropuerto ↔ Zona Complementaria Norte</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">Aeropuerto Rafael Núñez</div>
                        <div class="station-item complementaria">Complementaria Norte</div>
                        <div class="station-item complementaria">Zona Complementaria Norte</div>
                        <div class="station-item complementaria">Zona Complementaria Norte Extendida</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 6:00 AM - 10:00 PM</span>
                        <span>🕐 Frecuencia: 20-30 min</span>
                    </div>
                </div>
                
                <!-- C018 -->
                <div class="route-card">
                    <div class="route-header" style="background: linear-gradient(135deg, #FF851B, #e67e22);">
                        <h4>C018 - Complementaria Sur</h4>
                        <span class="route-info">El Pozón ↔ Zona Complementaria Sur</span>
                    </div>
                    <div class="route-stations">
                        <div class="station-item troncal">El Pozón</div>
                        <div class="station-item complementaria">Complementaria Sur</div>
                        <div class="station-item complementaria">Zona Complementaria Sur</div>
                        <div class="station-item complementaria">Zona Complementaria Sur Extendida</div>
                    </div>
                    <div class="route-footer">
                        <span>⏰ 6:00 AM - 10:00 PM</span>
                        <span>🕐 Frecuencia: 20-30 min</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    // Función para obtener la ciudad basada en coordenadas
    async function getCityFromCoords(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`);
            const data = await response.json();
            
            if (data.address) {
                // Priorizar ciudad, luego municipio, luego estado
                return data.address.city || 
                       data.address.town || 
                       data.address.municipality || 
                       data.address.state || 
                       data.address.country || 
                       'Ubicación desconocida';
            }
            return 'Ubicación desconocida';
        } catch (error) {
            console.error('Error obteniendo ciudad:', error);
            return 'Ubicación desconocida';
        }
    }

    // Función para actualizar el header con la ciudad detectada
    async function updateHeaderWithCity(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`);
            const data = await response.json();
            
            // Verificar si está en Cartagena
            const isInCartagena = data.display_name.toLowerCase().includes('cartagena') || 
                                 (data.address && data.address.city && data.address.city.toLowerCase().includes('cartagena')) ||
                                 (data.address && data.address.town && data.address.town.toLowerCase().includes('cartagena')) ||
                                 (data.address && data.address.municipality && data.address.municipality.toLowerCase().includes('cartagena'));
            
            if (isInCartagena) {
                const headerTitle = document.getElementById('headerTitle');
                headerTitle.textContent = `Mi Ruta - Cartagena`;
                document.getElementById('info').textContent = `Ubicación detectada en Cartagena. Selecciona tu punto de partida y destino para obtener la mejor ruta.`;
            } else {
                document.getElementById('headerTitle').textContent = 'Mi Ruta - Cartagena';
                document.getElementById('info').textContent = 'Ubicación detectada fuera de Cartagena. El mapa se ha centrado en el centro de la ciudad.';
            }
        } catch (error) {
            console.error('Error obteniendo información de la ciudad:', error);
            document.getElementById('headerTitle').textContent = 'Mi Ruta - Cartagena';
            document.getElementById('info').textContent = 'No se pudo obtener información de la ubicación. El mapa se ha centrado en Cartagena.';
        }
    }

    // Detectar ubicación al cargar la página
    function detectUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    
                    // Verificar si la ubicación está dentro de Cartagena
                    const isInCartagena = latitude >= 10.3 && latitude <= 10.5 && 
                                         longitude >= -75.6 && longitude <= -75.4;
                    
                    if (isInCartagena) {
                        await updateHeaderWithCity(latitude, longitude);
                        
                        // Centrar mapa en la ubicación del usuario
                        map.setView([latitude, longitude], 14);
                        
                        // Agregar marcador de ubicación actual
                        const userLocationIcon = L.divIcon({
                            className: 'user-location-icon',
                            html: '<div style="background: #ff6600; color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: bold; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3);">U</div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        });
                        
                        userMarker = L.marker([latitude, longitude], {icon: userLocationIcon})
                            .addTo(map)
                            .bindPopup('Tu ubicación actual en Cartagena')
                            .openPopup();
                        
                        // Actualizar automáticamente el campo de punto de partida
                        await updateStartPointField(latitude, longitude);
                        
                    } else {
                        // Si no está en Cartagena, centrar en el centro de la ciudad
                        document.getElementById('headerTitle').textContent = 'Mi Ruta - Cartagena';
                        map.setView([10.42312, -75.54802], 13);
                        document.getElementById('info').textContent = 'Ubicación detectada fuera de Cartagena. El mapa se ha centrado en el centro de la ciudad.';
                    }
                },
                (error) => {
                    console.error('Error obteniendo ubicación:', error);
                    document.getElementById('headerTitle').textContent = 'Mi Ruta - Cartagena';
                    document.getElementById('info').textContent = 'No se pudo obtener tu ubicación. El mapa se ha centrado en Cartagena.';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );
        } else {
            document.getElementById('headerTitle').textContent = 'Mi Ruta - Cartagena';
            document.getElementById('info').textContent = 'Geolocalización no soportada. El mapa se ha centrado en Cartagena.';
        }
    }

    // Coordenadas oficiales de estaciones y paraderos de Transcaribe (Cartagena)
    const estaciones = [
        // ESTACIONES PRINCIPALES - PORTAL
        { nombre: 'Portal de Transcaribe', coords: [10.39972, -75.47943], tipo: 'Portal', descripcion: 'Estación principal del sistema' },
        
        // ESTACIONES TRONCALES
        { nombre: 'Estación Centro', coords: [10.42312, -75.54802], tipo: 'Troncal', descripcion: 'Centro histórico de Cartagena' },
        { nombre: 'Estación Bocagrande', coords: [10.40444, -75.55111], tipo: 'Troncal', descripcion: 'Zona turística y hotelera' },
        { nombre: 'Estación Aeropuerto', coords: [10.45000, -75.51000], tipo: 'Troncal', descripcion: 'Aeropuerto Internacional Rafael Núñez' },
        { nombre: 'Estación La Boquilla', coords: [10.47000, -75.54000], tipo: 'Troncal', descripcion: 'Zona de playas y pesca' },
        { nombre: 'Estación El Pozón', coords: [10.38900, -75.47500], tipo: 'Troncal', descripcion: 'Zona residencial sur' },
        { nombre: 'Estación Mamonal', coords: [10.35000, -75.52000], tipo: 'Troncal', descripcion: 'Zona industrial' },
        { nombre: 'Estación Getsemaní', coords: [10.42000, -75.55000], tipo: 'Troncal', descripcion: 'Centro histórico' },
        { nombre: 'Estación San Diego', coords: [10.41500, -75.54500], tipo: 'Troncal', descripcion: 'Centro histórico' },
        { nombre: 'Estación Pie de la Popa', coords: [10.41000, -75.53500], tipo: 'Troncal', descripcion: 'Zona residencial' },
        { nombre: 'Estación Olaya Herrera', coords: [10.40000, -75.52500], tipo: 'Troncal', descripcion: 'Zona comercial' },
        
        // ESTACIONES PRETRONCALES
        { nombre: 'Estación Crespo', coords: [10.43500, -75.51300], tipo: 'Pretroncal', descripcion: 'Zona residencial norte' },
        { nombre: 'Estación Zona Sur', coords: [10.38000, -75.48000], tipo: 'Pretroncal', descripcion: 'Zona residencial sur' },
        { nombre: 'Estación Zona Oeste', coords: [10.40000, -75.56000], tipo: 'Pretroncal', descripcion: 'Zona residencial oeste' },
        { nombre: 'Estación Zona Periférica', coords: [10.39000, -75.51500], tipo: 'Pretroncal', descripcion: 'Zona periférica' },
        
        // ESTACIONES ALIMENTADORAS
        { nombre: 'Estación Alimentadora Norte', coords: [10.46000, -75.50000], tipo: 'Alimentadora', descripcion: 'Zona norte alimentadora' },
        { nombre: 'Estación Alimentadora Sur', coords: [10.38000, -75.47000], tipo: 'Alimentadora', descripcion: 'Zona sur alimentadora' },
        { nombre: 'Estación Alimentadora Este', coords: [10.42500, -75.55500], tipo: 'Alimentadora', descripcion: 'Zona este alimentadora' },
        { nombre: 'Estación Alimentadora Oeste', coords: [10.40000, -75.56000], tipo: 'Alimentadora', descripcion: 'Zona oeste alimentadora' },
        { nombre: 'Estación Alimentadora Central', coords: [10.41800, -75.54300], tipo: 'Alimentadora', descripcion: 'Zona central alimentadora' },
        { nombre: 'Estación Alimentadora Portal', coords: [10.40500, -75.48500], tipo: 'Alimentadora', descripcion: 'Zona portal alimentadora' },
        { nombre: 'Estación Alimentadora Crespo', coords: [10.44000, -75.51800], tipo: 'Alimentadora', descripcion: 'Zona Crespo alimentadora' },
        { nombre: 'Estación Alimentadora Mamonal', coords: [10.34500, -75.52500], tipo: 'Alimentadora', descripcion: 'Zona Mamonal alimentadora' },
        { nombre: 'Estación Alimentadora La Boquilla', coords: [10.47500, -75.54500], tipo: 'Alimentadora', descripcion: 'Zona La Boquilla alimentadora' },
        { nombre: 'Estación Alimentadora Periférica', coords: [10.38500, -75.52000], tipo: 'Alimentadora', descripcion: 'Zona periférica alimentadora' },
        
        // ESTACIONES COMPLEMENTARIAS
        { nombre: 'Estación Complementaria Principal', coords: [10.42800, -75.55300], tipo: 'Complementaria', descripcion: 'Zona complementaria principal' },
        { nombre: 'Estación Complementaria Norte', coords: [10.45500, -75.51500], tipo: 'Complementaria', descripcion: 'Zona complementaria norte' },
        { nombre: 'Estación Complementaria Sur', coords: [10.38400, -75.48000], tipo: 'Complementaria', descripcion: 'Zona complementaria sur' }
    ];
    
    // Rutas oficiales de Transcaribe según PDF oficial
    const rutas = [
        // RUTAS TRONCALES
        {
            nombre: 'T100E - Troncal Principal',
            categoria: 'Troncal',
            color: '#0074D9',
            descripcion: 'Portal - Centro - Bocagrande',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '5-8 minutos',
            estaciones: ['Portal de Transcaribe', 'Estación Centro', 'Estación Bocagrande'],
            puntos: [
                [10.39972, -75.47943], // Portal
                [10.41100, -75.51300], // Punto intermedio 1
                [10.42312, -75.54802], // Centro
                [10.41400, -75.54900], // Punto intermedio 2
                [10.40444, -75.55111]  // Bocagrande
            ]
        },
        {
            nombre: 'T101 - Troncal Norte',
            categoria: 'Troncal',
            color: '#0074D9',
            descripcion: 'Portal - Aeropuerto - La Boquilla',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '8-12 minutos',
            estaciones: ['Portal de Transcaribe', 'Estación Aeropuerto', 'Estación La Boquilla'],
            puntos: [
                [10.39972, -75.47943], // Portal
                [10.42500, -75.49500], // Punto intermedio 1
                [10.45000, -75.51000], // Aeropuerto
                [10.46000, -75.52500], // Punto intermedio 2
                [10.47000, -75.54000]  // La Boquilla
            ]
        },
        {
            nombre: 'T102 - Troncal Sur',
            categoria: 'Troncal',
            color: '#0074D9',
            descripcion: 'Portal - El Pozón - Mamonal',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '10-15 minutos',
            estaciones: ['Portal de Transcaribe', 'Estación El Pozón', 'Estación Mamonal'],
            puntos: [
                [10.39972, -75.47943], // Portal
                [10.39400, -75.47700], // Punto intermedio 1
                [10.38900, -75.47500], // El Pozón
                [10.37000, -75.49700], // Punto intermedio 2
                [10.35000, -75.52000]  // Mamonal
            ]
        },
        {
            nombre: 'T103 - Troncal Centro',
            categoria: 'Troncal',
            color: '#0074D9',
            descripcion: 'Getsemaní - San Diego - Pie de la Popa - Olaya Herrera',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '6-10 minutos',
            estaciones: ['Estación Getsemaní', 'Estación San Diego', 'Estación Pie de la Popa', 'Estación Olaya Herrera'],
            puntos: [
                [10.42000, -75.55000], // Getsemaní
                [10.41700, -75.54700], // Punto intermedio 1
                [10.41500, -75.54500], // San Diego
                [10.41200, -75.54000], // Punto intermedio 2
                [10.41000, -75.53500], // Pie de la Popa
                [10.40500, -75.53000], // Punto intermedio 3
                [10.40000, -75.52500]  // Olaya Herrera
            ]
        },
        
        // RUTAS PRETRONCALES
        {
            nombre: 'X101 - Pretroncal Norte',
            categoria: 'Pretroncal',
            color: '#2ECC40',
            descripcion: 'Portal - Crespo - Aeropuerto',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '8-12 minutos',
            estaciones: ['Portal de Transcaribe', 'Estación Crespo', 'Estación Aeropuerto'],
            puntos: [
                [10.39972, -75.47943], // Portal
                [10.41700, -75.49600], // Punto intermedio 1
                [10.43500, -75.51300], // Crespo
                [10.44200, -75.51100], // Punto intermedio 2
                [10.45000, -75.51000]  // Aeropuerto
            ]
        },
        {
            nombre: 'X102 - Pretroncal Sur',
            categoria: 'Pretroncal',
            color: '#2ECC40',
            descripcion: 'Portal - El Pozón - Zona Sur',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '10-15 minutos',
            estaciones: ['Portal de Transcaribe', 'Estación El Pozón', 'Estación Zona Sur'],
            puntos: [
                [10.39972, -75.47943], // Portal
                [10.39400, -75.47700], // Punto intermedio 1
                [10.38900, -75.47500], // El Pozón
                [10.38400, -75.47700], // Punto intermedio 2
                [10.38000, -75.48000]  // Zona Sur
            ]
        },
        {
            nombre: 'X103 - Pretroncal Este',
            categoria: 'Pretroncal',
            color: '#2ECC40',
            descripcion: 'Centro - Getsemaní - San Diego',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '8-12 minutos',
            estaciones: ['Estación Centro', 'Estación Getsemaní', 'Estación San Diego'],
            puntos: [
                [10.42312, -75.54802], // Centro
                [10.42100, -75.54900], // Punto intermedio 1
                [10.42000, -75.55000], // Getsemaní
                [10.41700, -75.54700], // Punto intermedio 2
                [10.41500, -75.54500]  // San Diego
            ]
        },
        {
            nombre: 'X104 - Pretroncal Oeste',
            categoria: 'Pretroncal',
            color: '#2ECC40',
            descripcion: 'Centro - Bocagrande - Zona Oeste',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '8-12 minutos',
            estaciones: ['Estación Centro', 'Estación Bocagrande', 'Estación Zona Oeste'],
            puntos: [
                [10.42312, -75.54802], // Centro
                [10.41400, -75.54900], // Punto intermedio 1
                [10.40444, -75.55111], // Bocagrande
                [10.40200, -75.55500], // Punto intermedio 2
                [10.40000, -75.56000]  // Zona Oeste
            ]
        },
        {
            nombre: 'X105 - Pretroncal Central',
            categoria: 'Pretroncal',
            color: '#2ECC40',
            descripcion: 'Portal - Pie de la Popa - Olaya Herrera',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '10-15 minutos',
            estaciones: ['Portal de Transcaribe', 'Estación Pie de la Popa', 'Estación Olaya Herrera'],
            puntos: [
                [10.39972, -75.47943], // Portal
                [10.40500, -75.50700], // Punto intermedio 1
                [10.41000, -75.53500], // Pie de la Popa
                [10.40500, -75.53000], // Punto intermedio 2
                [10.40000, -75.52500]  // Olaya Herrera
            ]
        },
        {
            nombre: 'X106 - Pretroncal Periférica',
            categoria: 'Pretroncal',
            color: '#2ECC40',
            descripcion: 'Pie de la Popa - Olaya Herrera - Zona Periférica',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '12-18 minutos',
            estaciones: ['Estación Pie de la Popa', 'Estación Olaya Herrera', 'Estación Zona Periférica'],
            puntos: [
                [10.41000, -75.53500], // Pie de la Popa
                [10.40500, -75.53000], // Punto intermedio 1
                [10.40000, -75.52500], // Olaya Herrera
                [10.39500, -75.52000], // Punto intermedio 2
                [10.39000, -75.51500]  // Zona Periférica
            ]
        },
        
        // RUTAS ALIMENTADORAS
        {
            nombre: 'A101 - Alimentadora Norte',
            categoria: 'Alimentadora',
            color: '#FF4136',
            descripcion: 'Aeropuerto - Zona Norte',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '15-20 minutos',
            estaciones: ['Estación Aeropuerto', 'Estación Alimentadora Norte'],
            puntos: [
                [10.45000, -75.51000], // Aeropuerto
                [10.45500, -75.50500], // Punto intermedio 1
                [10.46000, -75.50000], // Alimentadora Norte
                [10.46500, -75.49500], // Punto intermedio 2
                [10.47000, -75.49000]  // Zona Norte 2
            ]
        },
        {
            nombre: 'A102 - Alimentadora Sur',
            categoria: 'Alimentadora',
            color: '#FF4136',
            descripcion: 'El Pozón - Zona Sur',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '15-20 minutos',
            estaciones: ['Estación El Pozón', 'Estación Alimentadora Sur'],
            puntos: [
                [10.38900, -75.47500], // El Pozón
                [10.38400, -75.47200], // Punto intermedio 1
                [10.38000, -75.47000], // Alimentadora Sur
                [10.37500, -75.46700], // Punto intermedio 2
                [10.37000, -75.46500]  // Zona Sur 2
            ]
        },
        {
            nombre: 'A103 - Alimentadora Este',
            categoria: 'Alimentadora',
            color: '#FF4136',
            descripcion: 'Getsemaní - Zona Este',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '15-20 minutos',
            estaciones: ['Estación Getsemaní', 'Estación Alimentadora Este'],
            puntos: [
                [10.42000, -75.55000], // Getsemaní
                [10.42200, -75.55200], // Punto intermedio 1
                [10.42500, -75.55500], // Alimentadora Este
                [10.42700, -75.55700], // Punto intermedio 2
                [10.43000, -75.56000]  // Zona Este 2
            ]
        },
        {
            nombre: 'A104 - Alimentadora Oeste',
            categoria: 'Alimentadora',
            color: '#FF4136',
            descripcion: 'Bocagrande - Zona Oeste',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '15-20 minutos',
            estaciones: ['Estación Bocagrande', 'Estación Alimentadora Oeste'],
            puntos: [
                [10.40444, -75.55111], // Bocagrande
                [10.40200, -75.55500], // Punto intermedio 1
                [10.40000, -75.56000], // Alimentadora Oeste
                [10.39700, -75.56500], // Punto intermedio 2
                [10.39500, -75.57000]  // Zona Oeste 2
            ]
        },
        {
            nombre: 'A105 - Alimentadora Central',
            categoria: 'Alimentadora',
            color: '#FF4136',
            descripcion: 'Centro - Zona Central',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '15-20 minutos',
            estaciones: ['Estación Centro', 'Estación Alimentadora Central'],
            puntos: [
                [10.42312, -75.54802], // Centro
                [10.42000, -75.54500], // Punto intermedio 1
                [10.41800, -75.54300], // Alimentadora Central
                [10.41500, -75.54000], // Punto intermedio 2
                [10.41300, -75.53800]  // Zona Central 2
            ]
        },
        {
            nombre: 'A107 - Alimentadora Portal',
            categoria: 'Alimentadora',
            color: '#FF4136',
            descripcion: 'Portal - Zona Portal',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '15-20 minutos',
            estaciones: ['Portal de Transcaribe', 'Estación Alimentadora Portal'],
            puntos: [
                [10.39972, -75.47943], // Portal
                [10.40200, -75.48200], // Punto intermedio 1
                [10.40500, -75.48500], // Alimentadora Portal
                [10.40700, -75.48700], // Punto intermedio 2
                [10.41000, -75.49000]  // Zona Portal 2
            ]
        },
        {
            nombre: 'A108 - Alimentadora Crespo',
            categoria: 'Alimentadora',
            color: '#FF4136',
            descripcion: 'Crespo - Zona Crespo',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '15-20 minutos',
            estaciones: ['Estación Crespo', 'Estación Alimentadora Crespo'],
            puntos: [
                [10.43500, -75.51300], // Crespo
                [10.43700, -75.51500], // Punto intermedio 1
                [10.44000, -75.51800], // Alimentadora Crespo
                [10.44200, -75.52000], // Punto intermedio 2
                [10.44500, -75.52300]  // Zona Crespo 2
            ]
        },
        {
            nombre: 'A111 - Alimentadora Mamonal',
            categoria: 'Alimentadora',
            color: '#FF4136',
            descripcion: 'Mamonal - Zona Mamonal',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '15-20 minutos',
            estaciones: ['Estación Mamonal', 'Estación Alimentadora Mamonal'],
            puntos: [
                [10.35000, -75.52000], // Mamonal
                [10.34700, -75.52200], // Punto intermedio 1
                [10.34500, -75.52500], // Alimentadora Mamonal
                [10.34200, -75.52700], // Punto intermedio 2
                [10.34000, -75.53000]  // Zona Mamonal 2
            ]
        },
        {
            nombre: 'A114 - Alimentadora La Boquilla',
            categoria: 'Alimentadora',
            color: '#FF4136',
            descripcion: 'La Boquilla - Zona Boquilla',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '15-20 minutos',
            estaciones: ['Estación La Boquilla', 'Estación Alimentadora La Boquilla'],
            puntos: [
                [10.47000, -75.54000], // La Boquilla
                [10.47200, -75.54200], // Punto intermedio 1
                [10.47500, -75.54500], // Alimentadora La Boquilla
                [10.47700, -75.54700], // Punto intermedio 2
                [10.48000, -75.55000]  // Zona Boquilla 2
            ]
        },
        {
            nombre: 'A117 - Alimentadora Periférica',
            categoria: 'Alimentadora',
            color: '#FF4136',
            descripcion: 'Zona Periférica - Zona Periférica Extendida',
            horario: '5:00 AM - 11:00 PM',
            frecuencia: '20-25 minutos',
            estaciones: ['Estación Alimentadora Periférica'],
            puntos: [
                [10.39000, -75.51500], // Zona Periférica
                [10.38700, -75.51700], // Punto intermedio 1
                [10.38500, -75.52000], // Alimentadora Periférica
                [10.38200, -75.52200], // Punto intermedio 2
                [10.38000, -75.52500]  // Zona Periférica 2
            ]
        },
        
        // RUTAS COMPLEMENTARIAS
        {
            nombre: 'C001 - Complementaria Principal',
            categoria: 'Complementaria',
            color: '#FF851B',
            descripcion: 'Centro - Zona Complementaria',
            horario: '6:00 AM - 10:00 PM',
            frecuencia: '20-30 minutos',
            estaciones: ['Estación Centro', 'Estación Complementaria Principal'],
            puntos: [
                [10.42312, -75.54802], // Centro
                [10.42500, -75.55000], // Punto intermedio 1
                [10.42800, -75.55300], // Complementaria Principal
                [10.43000, -75.55500], // Punto intermedio 2
                [10.43300, -75.55800]  // Zona Complementaria 2
            ]
        },
        {
            nombre: 'C017 - Complementaria Norte',
            categoria: 'Complementaria',
            color: '#FF851B',
            descripcion: 'Aeropuerto - Zona Complementaria Norte',
            horario: '6:00 AM - 10:00 PM',
            frecuencia: '20-30 minutos',
            estaciones: ['Estación Aeropuerto', 'Estación Complementaria Norte'],
            puntos: [
                [10.45000, -75.51000], // Aeropuerto
                [10.45200, -75.51200], // Punto intermedio 1
                [10.45500, -75.51500], // Complementaria Norte
                [10.45700, -75.51700], // Punto intermedio 2
                [10.46000, -75.52000]  // Zona Complementaria Norte 2
            ]
        },
        {
            nombre: 'C018 - Complementaria Sur',
            categoria: 'Complementaria',
            color: '#FF851B',
            descripcion: 'El Pozón - Zona Complementaria Sur',
            horario: '6:00 AM - 10:00 PM',
            frecuencia: '20-30 minutos',
            estaciones: ['Estación El Pozón', 'Estación Complementaria Sur'],
            puntos: [
                [10.38900, -75.47500], // El Pozón
                [10.38600, -75.47700], // Punto intermedio 1
                [10.38400, -75.48000], // Complementaria Sur
                [10.38100, -75.48200], // Punto intermedio 2
                [10.37900, -75.48500]  // Zona Complementaria Sur 2
            ]
        }
    ];

    let map = L.map('map').setView([10.42312, -75.54802], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Establecer límites del mapa solo para Cartagena
    const cartagenaBounds = L.latLngBounds(
        [10.3, -75.6], // Suroeste
        [10.5, -75.4]  // Noreste
    );
    
    // Restringir el mapa a los límites de Cartagena
    map.setMaxBounds(cartagenaBounds);
    map.setMinZoom(11); // Zoom mínimo para mantener enfoque en la ciudad
    
    // Agregar un borde visual para delimitar Cartagena
    L.rectangle(cartagenaBounds, {
        color: "#6b46c1",
        weight: 2,
        fillColor: "transparent",
        fillOpacity: 0,
        opacity: 0.3
    }).addTo(map);

    // Mostrar estaciones con iconos personalizados según tipo
    estaciones.forEach(est => {
        let iconHtml, iconColor;
        
        switch(est.tipo) {
            case 'Portal':
                iconHtml = '<div style="background: #ff6600; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 0 6px rgba(0,0,0,0.3);">P</div>';
                iconColor = '#ff6600';
                break;
            case 'Troncal':
                iconHtml = '<div style="background: #0074D9; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3);">T</div>';
                iconColor = '#0074D9';
                break;
            case 'Pretroncal':
                iconHtml = '<div style="background: #2ECC40; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3);">X</div>';
                iconColor = '#2ECC40';
                break;
            case 'Alimentadora':
                iconHtml = '<div style="background: #FF4136; color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: bold; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3);">A</div>';
                iconColor = '#FF4136';
                break;
            case 'Complementaria':
                iconHtml = '<div style="background: #FF851B; color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: bold; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3);">C</div>';
                iconColor = '#FF851B';
                break;
            default:
                iconHtml = '<div style="background: #ff6600; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">S</div>';
                iconColor = '#ff6600';
        }
        
        const stationIcon = L.divIcon({
            className: 'station-icon',
            html: iconHtml,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
        
        // Buscar rutas que pasan por esta estación
        const rutasEstacion = rutas.filter(ruta => (ruta.estaciones || []).some(nombre => nombre.includes(est.nombre.replace('Estación ', ''))));
        let rutasHtml = '';
        if (rutasEstacion.length > 0) {
            rutasHtml = '<ul style="margin:0; padding-left:1.2em;">' + rutasEstacion.map(ruta => `<li><span style='color:${ruta.color};font-weight:bold;'>${ruta.nombre}</span> <span style='font-size:0.9em;'>(${ruta.horario}, ${ruta.frecuencia})</span></li>`).join('') + '</ul>';
        } else {
            rutasHtml = '<em>No pasan rutas directas</em>';
        }
        let popupContent = `<b>${est.nombre}</b><br>` +
            `<small>Tipo: ${est.tipo}</small><br>` +
            `<small style='color:${iconColor};'>● Estación ${est.tipo}</small><br>` +
            (est.descripcion ? `<small><b>Descripción:</b> ${est.descripcion}</small><br>` : '') +
            `<b>Rutas que pasan por aquí:</b><br>${rutasHtml}`;
        L.marker(est.coords, {icon: stationIcon}).addTo(map).bindPopup(popupContent);
    });
    
    // Mostrar rutas por categoría con información detallada
    const categorias = ['Troncal', 'Pretroncal', 'Alimentadora', 'Complementaria'];
    const colores = ['#0074D9', '#2ECC40', '#FF4136', '#FF851B'];
    
    categorias.forEach((categoria, index) => {
        const rutasCategoria = rutas.filter(ruta => ruta.categoria === categoria);
        rutasCategoria.forEach(ruta => {
            const routeLine = L.polyline(ruta.puntos, { 
                color: colores[index], 
                weight: 4, 
                opacity: 0.8 
            }).addTo(map);
            
            // Crear popup con información detallada de la ruta
            let popupContent = `<b>${ruta.nombre}</b><br>`;
            popupContent += `<small><strong>Descripción:</strong> ${ruta.descripcion}</small><br>`;
            popupContent += `<small><strong>Categoría:</strong> ${ruta.categoria}</small><br>`;
            popupContent += `<small><strong>Horario:</strong> ${ruta.horario}</small><br>`;
            popupContent += `<small><strong>Frecuencia:</strong> ${ruta.frecuencia}</small><br>`;
            popupContent += `<small><strong>Estaciones:</strong></small><br>`;
            ruta.estaciones.forEach(estacion => {
                popupContent += `<small style="color: ${colores[index]};">● ${estacion}</small><br>`;
            });
            
            routeLine.bindPopup(popupContent);
        });
    });

    // Variables globales
    let startMarker = null, endMarker = null, routeLine = null;
    let selecting = null;
    let userMarker = null, watchId = null, alarmed = false;

    // Función para geocodificación usando Nominatim (OpenStreetMap) con búsqueda de POIs solo en Cartagena
    async function geocodeAddress(address) {
        try {
            // Búsqueda general de direcciones solo en Cartagena
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Cartagena, Colombia')}&limit=10&addressdetails=1&viewbox=-75.6,10.3,-75.4,10.5&bounded=1`);
            const data = await response.json();
            
            // Búsqueda específica de POIs solo en Cartagena
            const poiResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Cartagena')}&limit=10&addressdetails=1&amenity=1&shop=1&tourism=1&office=1&leisure=1&viewbox=-75.6,10.3,-75.4,10.5&bounded=1`);
            const poiData = await poiResponse.json();
            
            // Combinar y filtrar resultados únicos, asegurando que sean de Cartagena
            const allResults = [...data, ...poiData];
            const uniqueResults = allResults.filter((item, index, self) => {
                // Verificar que no sea duplicado
                const isDuplicate = index === self.findIndex(t => t.place_id === item.place_id);
                
                // Verificar que esté en Cartagena
                const isInCartagena = item.display_name.toLowerCase().includes('cartagena') || 
                                     (item.address && item.address.city && item.address.city.toLowerCase().includes('cartagena')) ||
                                     (item.address && item.address.town && item.address.town.toLowerCase().includes('cartagena')) ||
                                     (item.address && item.address.municipality && item.address.municipality.toLowerCase().includes('cartagena'));
                
                return isDuplicate && isInCartagena;
            });
            
            return uniqueResults;
        } catch (error) {
            console.error('Error en geocodificación:', error);
            return [];
        }
    }

    // Función para búsqueda avanzada de POIs solo en Cartagena
    async function searchPOIs(query, category = 'all') {
        try {
            let searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Cartagena')}&limit=15&addressdetails=1&viewbox=-75.6,10.3,-75.4,10.5&bounded=1`;
            
            // Agregar filtros específicos según la categoría
            switch(category) {
                case 'restaurants':
                    searchUrl += '&amenity=restaurant&amenity=cafe&amenity=bar&amenity=fast_food';
                    break;
                case 'hotels':
                    searchUrl += '&tourism=hotel&tourism=hostel&tourism=motel&tourism=guest_house';
                    break;
                case 'shops':
                    searchUrl += '&shop=supermarket&shop=convenience&shop=department_store&shop=mall';
                    break;
                case 'businesses':
                    searchUrl += '&office=company&office=yes&amenity=bank&amenity=pharmacy';
                    break;
                case 'entertainment':
                    searchUrl += '&leisure=cinema&leisure=theatre&amenity=nightclub&tourism=museum';
                    break;
                case 'healthcare':
                    searchUrl += '&amenity=hospital&amenity=clinic&amenity=pharmacy&amenity=doctors';
                    break;
                case 'education':
                    searchUrl += '&amenity=school&amenity=university&amenity=college&amenity=kindergarten';
                    break;
                case 'transport':
                    searchUrl += '&amenity=bus_station&amenity=taxi&amenity=car_rental&highway=bus_stop';
                    break;
            }
            
            const response = await fetch(searchUrl);
            const data = await response.json();
            
            // Filtrar solo resultados de Cartagena
            const cartagenaResults = data.filter(item => {
                return item.display_name.toLowerCase().includes('cartagena') || 
                       (item.address && item.address.city && item.address.city.toLowerCase().includes('cartagena')) ||
                       (item.address && item.address.town && item.address.town.toLowerCase().includes('cartagena')) ||
                       (item.address && item.address.municipality && item.address.municipality.toLowerCase().includes('cartagena'));
            });
            
            // Procesar y categorizar resultados
            return cartagenaResults.map(item => {
                let category = 'other';
                let icon = '📍';
                
                // Categorizar según el tipo de POI
                if (item.amenity) {
                    switch(item.amenity) {
                        case 'restaurant':
                        case 'cafe':
                        case 'bar':
                        case 'fast_food':
                            category = 'restaurant';
                            icon = '🍽️';
                            break;
                        case 'hotel':
                        case 'hostel':
                        case 'motel':
                        case 'guest_house':
                            category = 'hotel';
                            icon = '🏨';
                            break;
                        case 'bank':
                        case 'pharmacy':
                            category = 'business';
                            icon = '🏢';
                            break;
                        case 'hospital':
                        case 'clinic':
                        case 'doctors':
                            category = 'healthcare';
                            icon = '🏥';
                            break;
                        case 'school':
                        case 'university':
                        case 'college':
                        case 'kindergarten':
                            category = 'education';
                            icon = '🎓';
                            break;
                        case 'bus_station':
                        case 'taxi':
                        case 'car_rental':
                            category = 'transport';
                            icon = '🚌';
                            break;
                    }
                } else if (item.shop) {
                    category = 'shop';
                    icon = '🛒';
                } else if (item.tourism) {
                    category = 'tourism';
                    icon = '🏛️';
                } else if (item.office) {
                    category = 'business';
                    icon = '🏢';
                } else if (item.leisure) {
                    category = 'entertainment';
                    icon = '🎭';
                }
                
                return {
                    ...item,
                    category,
                    icon,
                    displayName: `${icon} ${item.display_name.split(',')[0]}`
                };
            });
        } catch (error) {
            console.error('Error buscando POIs:', error);
            return [];
        }
    }

    // Función para actualizar placeholders según la categoría seleccionada
    function updateSearchPlaceholders() {
        const category = document.getElementById('searchCategory').value;
        const startInput = document.getElementById('startInput');
        const endInput = document.getElementById('endInput');
        
        const placeholders = {
            'all': 'Ej: Centro Histórico, Cartagena',
            'restaurants': 'Ej: Restaurante en Getsemaní, Cartagena',
            'hotels': 'Ej: Hotel en Bocagrande, Cartagena',
            'shops': 'Ej: Centro Comercial Caribe Plaza, Cartagena',
            'businesses': 'Ej: Banco en Centro, Cartagena',
            'entertainment': 'Ej: Teatro Heredia, Cartagena',
            'healthcare': 'Ej: Hospital Naval, Cartagena',
            'education': 'Ej: Universidad de Cartagena',
            'transport': 'Ej: Terminal de Transportes, Cartagena'
        };
        
        startInput.placeholder = placeholders[category] || placeholders['all'];
        endInput.placeholder = placeholders[category] || placeholders['all'];
    }

    // Función para buscar ubicación mejorada
    async function searchLocation(type) {
        const input = document.getElementById(type === 'start' ? 'startInput' : 'endInput');
        const query = input.value.trim();
        if (!query) return;

        // Buscar tanto POIs como direcciones
        const poiResults = await searchPOIs(query);
        const addressResults = await geocodeAddress(query);
        const results = [...poiResults, ...addressResults];

        if (!results.length) {
            document.getElementById('info').textContent = 'No se encontró la ubicación.';
            return;
        }
        const location = results[0];
        const latlng = [parseFloat(location.lat), parseFloat(location.lon)];
        if (type === 'start') {
            if (window.startMarker) map.removeLayer(window.startMarker);
            window.startMarker = L.marker(latlng, {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[32,32],iconAnchor:[16,32]})}).addTo(map).bindPopup('Punto de partida').openPopup();
            document.getElementById('info').textContent = `Punto de partida: ${location.displayName || location.display_name}`;
            mostrarDistanciaYTiempo();
        } else {
            await setEndMarkerFromInput(latlng[0], latlng[1], location.displayName || location.display_name);
            document.getElementById('info').textContent = `Destino: ${location.displayName || location.display_name}`;
            mostrarDistanciaYTiempo();
            mostrarEstacionCercanaADestino(latlng);
        }
        map.setView(latlng, 16);
    }

    // Función para obtener nombre de categoría
    function getCategoryName(category) {
        const names = {
            'all': 'lugar',
            'restaurants': 'restaurante',
            'hotels': 'hotel',
            'shops': 'tienda',
            'businesses': 'negocio',
            'entertainment': 'lugar de entretenimiento',
            'healthcare': 'centro de salud',
            'education': 'centro educativo',
            'transport': 'punto de transporte'
        };
        return names[category] || 'lugar';
    }

    // Autocompletado mejorado
    let timeoutId;
    function setupAutocomplete(inputId, suggestionsId) {
        const input = document.getElementById(inputId);
        const suggestions = document.getElementById(suggestionsId);
        
        input.addEventListener('input', async function() {
            clearTimeout(timeoutId);
            const query = this.value.trim();
            const category = document.getElementById('searchCategory').value;
            
            if (query.length < 3) {
                suggestions.style.display = 'none';
                return;
            }
            
            timeoutId = setTimeout(async () => {
                try {
                    // Buscar POIs y direcciones
                    const poiResults = await searchPOIs(query);
                    const addressResults = await geocodeAddress(query);
                    
                    // Combinar y limitar resultados
                    const allResults = [...poiResults, ...addressResults].slice(0, 8);
                    
                    if (allResults.length > 0) {
                        suggestions.innerHTML = '';
                        allResults.forEach(result => {
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.2em;">${result.icon || '📍'}</span>
                                    <div>
                                        <div style="font-weight: 500;">${result.displayName || result.display_name.split(',')[0]}</div>
                                        <div style="font-size: 0.8em; color: #666;">${result.display_name.split(',').slice(1, 3).join(',')}</div>
                                    </div>
                                </div>
                            `;
                            
                            div.addEventListener('click', () => {
                                input.value = result.displayName || result.display_name.split(',')[0];
                                suggestions.style.display = 'none';
                                
                                // Automáticamente buscar la ubicación
                                if (inputId === 'startInput') {
                                    searchLocation('start');
                                } else {
                                    searchLocation('end');
                                }
                            });
                            
                            suggestions.appendChild(div);
                        });
                        suggestions.style.display = 'block';
                    } else {
                        suggestions.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error en autocompletado:', error);
                    suggestions.style.display = 'none';
                }
            }, 300);
        });
        
        // Ocultar sugerencias al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.style.display = 'none';
            }
        });
    }

    // Configurar autocompletado
    setupAutocomplete('startInput', 'startSuggestions');
    setupAutocomplete('endInput', 'endSuggestions');

    // Selección en mapa
    document.getElementById('setStart').onclick = () => {
        selecting = 'start';
        document.getElementById('info').textContent = 'Haz clic en el mapa para seleccionar el punto de partida.';
    };
    
    document.getElementById('setEnd').onclick = () => {
        selecting = 'end';
        document.getElementById('info').textContent = 'Haz clic en el mapa para seleccionar el destino.';
    };
    
    map.on('click', async function(e) {
        if (selecting === 'start') {
            if (window.startMarker) map.removeLayer(window.startMarker);
            window.startMarker = L.marker(e.latlng, {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[32,32],iconAnchor:[16,32]})}).addTo(map).bindPopup('Punto de partida').openPopup();
            selecting = null;
            const locationInfo = await getLocationInfo(e.latlng);
            document.getElementById('startInput').value = locationInfo;
            document.getElementById('info').textContent = 'Punto de partida seleccionado en el mapa.';
            mostrarDistanciaYTiempo();
        } else if (selecting === 'end') {
            if (window.endMarker) map.removeLayer(window.endMarker);
            window.endMarker = L.marker(e.latlng, {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684912.png',iconSize:[32,32],iconAnchor:[16,32]})}).addTo(map).bindPopup('Destino').openPopup();
            selecting = null;
            const locationInfo = await getLocationInfo(e.latlng);
            document.getElementById('endInput').value = locationInfo;
            document.getElementById('info').textContent = 'Destino seleccionado en el mapa.';
            mostrarDistanciaYTiempo();
            mostrarEstacionCercanaADestino([e.latlng.lat, e.latlng.lng]);
        }
    });

    // Iniciar recorrido
    document.getElementById('startRoute').onclick = async () => {
        // Si no hay marcadores, intentar marcarlos automáticamente usando los textos
        const startInput = document.getElementById('startInput').value.trim();
        const endInput = document.getElementById('endInput').value.trim();
        if (!window.startMarker && startInput) {
            await searchLocation('start');
        }
        if (!window.endMarker && endInput) {
            await searchLocation('end');
        }
        if (!window.startMarker || !window.endMarker) {
            document.getElementById('info').textContent = 'Selecciona ambos puntos primero (por texto o en el mapa).';
            return;
        }
        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline([window.startMarker.getLatLng(), window.endMarker.getLatLng()], {
            color: '#ff6600', 
            dashArray: '8,8', 
            weight: 4
        }).addTo(map).bindPopup('Tu ruta personalizada');
        map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
        document.getElementById('info').textContent = '¡Recorrido iniciado! Se mostrará tu ubicación en tiempo real.';
        startTracking();
    };

    // Limpiar ruta
    document.getElementById('clearRoute').onclick = () => {
        if (startMarker) {
            map.removeLayer(startMarker);
            startMarker = null;
        }
        if (endMarker) {
            map.removeLayer(endMarker);
            endMarker = null;
        }
        if (routeLine) {
            map.removeLayer(routeLine);
            routeLine = null;
        }
        if (userMarker) {
            map.removeLayer(userMarker);
            userMarker = null;
        }
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
        
        document.getElementById('startInput').value = '';
        document.getElementById('endInput').value = '';
        document.getElementById('info').textContent = 'Ruta limpiada. Puedes seleccionar nuevos puntos.';
        alarmed = false;
        // Recargar automáticamente el punto de partida
        autoUpdateStartPoint();
    };

    // Seguimiento en tiempo real y alarma de proximidad
    function startTracking() {
        if (watchId) navigator.geolocation.clearWatch(watchId);
        alarmed = false;
        
        watchId = navigator.geolocation.watchPosition(pos => {
            const latlng = [pos.coords.latitude, pos.coords.longitude];
            
            if (userMarker) {
                userMarker.setLatLng(latlng);
            } else {
                userMarker = L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', 
                        iconSize: [28,28], 
                        iconAnchor: [14,28]
                    })
                }).addTo(map).bindPopup('Tu ubicación').openPopup();
            }
            
            // Calcular distancia al destino
            if (endMarker && !alarmed) {
                const dist = map.distance(latlng, endMarker.getLatLng());
                if (dist <= 200) {
                    alarmed = true;
                    document.getElementById('info').textContent = '¡Estás a menos de 200 metros de tu destino!';
                    
                    if (window.Notification && Notification.permission === 'granted') {
                        new Notification('¡Estás cerca de tu destino!', { 
                            body: 'Faltan menos de 200 metros.' 
                        });
                    } else {
                        alert('¡Estás a menos de 200 metros de tu destino!');
                    }
                }
            }
        }, err => {
            document.getElementById('info').textContent = 'No se pudo obtener tu ubicación. Verifica los permisos de ubicación.';
        }, { enableHighAccuracy: true });
    }

    // Solicitar permiso de notificaciones
    if (window.Notification && Notification.permission !== 'granted') {
        Notification.requestPermission();
    }

    // Detectar ubicación al cargar la página
    detectUserLocation();
    
    // Función para obtener información detallada de una ubicación
    async function getLocationInfo(latlng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&zoom=16&addressdetails=1`);
            const data = await response.json();
            
            if (data.display_name) {
                // Extraer información relevante
                const address = data.address;
                let locationName = '';
                
                if (address.road && address.house_number) {
                    locationName = `${address.road} ${address.house_number}`;
                } else if (address.road) {
                    locationName = address.road;
                } else if (address.suburb) {
                    locationName = address.suburb;
                } else if (address.neighbourhood) {
                    locationName = address.neighbourhood;
                } else {
                    locationName = data.display_name.split(',')[0];
                }
                
                if (address.city || address.town) {
                    locationName += `, ${address.city || address.town}`;
                }
                
                return locationName || data.display_name;
            }
            return `Lat: ${latlng.lat.toFixed(6)}, Lng: ${latlng.lng.toFixed(6)}`;
        } catch (error) {
            console.error('Error obteniendo información de ubicación:', error);
            return `Lat: ${latlng.lat.toFixed(6)}, Lng: ${latlng.lng.toFixed(6)}`;
        }
    }

    // Función para seguir la ubicación del usuario
    function startLocationTracking() {
        if (navigator.geolocation) {
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    
                    // Verificar si la ubicación está dentro de Cartagena
                    const isInCartagena = latitude >= 10.3 && latitude <= 10.5 && 
                                         longitude >= -75.6 && longitude <= -75.4;
                    
                    if (!isInCartagena) {
                        // Si sale de Cartagena, mostrar advertencia
                        document.getElementById('info').textContent = 'Has salido del área de Cartagena. El seguimiento de ubicación se ha pausado.';
                        stopLocationTracking();
                        return;
                    }
                    
                    // Actualizar marcador de usuario
                    if (userMarker) {
                        userMarker.setLatLng([latitude, longitude]);
                    } else {
                        const userLocationIcon = L.divIcon({
                            className: 'user-location-icon',
                            html: '<div style="background: #ff6600; color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: bold; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3);">U</div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        });
                        userMarker = L.marker([latitude, longitude], {icon: userLocationIcon}).addTo(map);
                    }
                    
                    // Verificar si está cerca del destino
                    if (endMarker && !alarmed) {
                        const distance = map.distance([latitude, longitude], endMarker.getLatLng());
                        if (distance <= 200) {
                            alarmed = true;
                            alert('¡Estás a 200 metros de tu destino!');
                        }
                    }
                },
                (error) => {
                    console.error('Error en seguimiento de ubicación:', error);
                    document.getElementById('info').textContent = 'Error en el seguimiento de ubicación.';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );
        }
    }

    // Inicializar la aplicación
    document.addEventListener('DOMContentLoaded', function() {
        // Centrar el mapa en Cartagena por defecto
        map.setView([10.42312, -75.54802], 13);
        
        // Detectar ubicación del usuario
        detectUserLocation();
        
        // Actualizar automáticamente el punto de partida con la ubicación actual
        autoUpdateStartPoint();
        
        // Configurar eventos de búsqueda
        setupSearchEvents();
        
        // Configurar eventos de selección en mapa
        setupMapEvents();
        
        // Configurar evento del botón de actualización de ubicación
        document.getElementById('updateLocationBtn').addEventListener('click', updateStartPointWithCurrentLocation);
        
        // Inicializar placeholders
        updateSearchPlaceholders();
        
        // Mostrar información inicial
        document.getElementById('info').textContent = 'Sistema de rutas y navegación para Cartagena. Selecciona tu punto de partida y destino para obtener la mejor ruta.';
    });

    // Función para actualizar el campo de punto de partida con la ubicación actual
    async function updateStartPointWithCurrentLocation() {
        const updateBtn = document.getElementById('updateLocationBtn');
        const startInput = document.getElementById('startInput');
        
        // Agregar clase de carga
        updateBtn.classList.add('loading');
        
        try {
            // Obtener ubicación actual de forma automática
            const position = await getCurrentPosition();
            const { latitude, longitude } = position.coords;
            
            // Verificar si está en Cartagena
            const isInCartagena = latitude >= 10.3 && latitude <= 10.5 && 
                                 longitude >= -75.6 && longitude <= -75.4;
            
            if (!isInCartagena) {
                alert('Tu ubicación actual está fuera de Cartagena. El sistema está optimizado para esta ciudad.');
                updateBtn.classList.remove('loading');
                return;
            }
            
            // Obtener dirección detallada automáticamente
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1&zoom=18&accept-language=es`);
            const data = await response.json();
            
            if (data.display_name) {
                // Formatear la dirección de forma automática y legible
                let formattedAddress = '';
                if (data.address) {
                    const addr = data.address;
                    if (addr.road && addr.house_number) {
                        formattedAddress = `${addr.road} #${addr.house_number}`;
                    } else if (addr.road) {
                        formattedAddress = addr.road;
                    } else if (addr.neighbourhood) {
                        formattedAddress = addr.neighbourhood;
                    } else if (addr.suburb) {
                        formattedAddress = addr.suburb;
                    }
                    if (addr.neighbourhood && !formattedAddress.includes(addr.neighbourhood)) {
                        formattedAddress += `, ${addr.neighbourhood}`;
                    } else if (addr.suburb && !formattedAddress.includes(addr.suburb)) {
                        formattedAddress += `, ${addr.suburb}`;
                    }
                    if (addr.city_district && !formattedAddress.includes(addr.city_district)) {
                        formattedAddress += `, ${addr.city_district}`;
                    }
                }
                if (!formattedAddress) {
                    const addressParts = data.display_name.split(', ');
                    formattedAddress = addressParts.slice(0, 3).join(', ');
                }
                if (!formattedAddress.toLowerCase().includes('cartagena')) {
                    formattedAddress += ', Cartagena';
                }
                // Actualizar el campo de entrada automáticamente
                startInput.value = formattedAddress;
                document.getElementById('info').textContent = `📍 Ubicación actual detectada automáticamente: ${formattedAddress}`;
                map.setView([latitude, longitude], 16);
                // Agregar o actualizar marcador de ubicación actual
                if (userMarker) {
                    userMarker.setLatLng([latitude, longitude]);
                    userMarker.openPopup();
                } else {
                    const userLocationIcon = L.divIcon({
                        className: 'user-location-icon',
                        html: '<div style="background: #ff6600; color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: bold; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3);">U</div>',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    });
                    userMarker = L.marker([latitude, longitude], {icon: userLocationIcon})
                        .addTo(map)
                        .bindPopup('📍 Tu ubicación actual en Cartagena')
                        .openPopup();
                }
                // --- CORRECCIÓN: Crear o actualizar el marcador de punto de partida (startMarker) ---
                if (window.startMarker) {
                    map.removeLayer(window.startMarker);
                }
                window.startMarker = L.marker([latitude, longitude]).addTo(map).bindPopup('Punto de partida').openPopup();
                // Iniciar seguimiento de ubicación automáticamente si no está activo
                if (!watchId) {
                    startLocationTracking();
                }
                // Limpiar cualquier sugerencia previa
                const startSuggestions = document.getElementById('startSuggestions');
                if (startSuggestions) {
                    startSuggestions.innerHTML = '';
                    startSuggestions.style.display = 'none';
                }
            } else {
                throw new Error('No se pudo obtener la dirección automáticamente');
            }
        } catch (error) {
            console.error('Error obteniendo ubicación actual automáticamente:', error);
            alert('No se pudo obtener tu ubicación actual automáticamente. Verifica que tengas habilitada la geolocalización y que estés en Cartagena.');
        } finally {
            updateBtn.classList.remove('loading');
        }
    }
    
    // Función helper para obtener la posición actual como Promise
    function getCurrentPosition() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocalización no soportada'));
                return;
            }
            
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            });
        });
    }

    // Función para actualizar automáticamente el punto de partida al cargar la página
    async function autoUpdateStartPoint() {
        try {
            // Obtener ubicación actual automáticamente
            const position = await getCurrentPosition();
            const { latitude, longitude } = position.coords;
            const isInCartagena = latitude >= 10.3 && latitude <= 10.5 && longitude >= -75.6 && longitude <= -75.4;
            if (isInCartagena) {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1&zoom=18&accept-language=es`);
                const data = await response.json();
                if (data.display_name) {
                    let formattedAddress = '';
                    if (data.address) {
                        const addr = data.address;
                        if (addr.road && addr.house_number) {
                            formattedAddress = `${addr.road} #${addr.house_number}`;
                        } else if (addr.road) {
                            formattedAddress = addr.road;
                        } else if (addr.neighbourhood) {
                            formattedAddress = addr.neighbourhood;
                        } else if (addr.suburb) {
                            formattedAddress = addr.suburb;
                        }
                        if (addr.neighbourhood && !formattedAddress.includes(addr.neighbourhood)) {
                            formattedAddress += `, ${addr.neighbourhood}`;
                        } else if (addr.suburb && !formattedAddress.includes(addr.suburb)) {
                            formattedAddress += `, ${addr.suburb}`;
                        }
                        if (addr.city_district && !formattedAddress.includes(addr.city_district)) {
                            formattedAddress += `, ${addr.city_district}`;
                        }
                    }
                    if (!formattedAddress) {
                        const addressParts = data.display_name.split(', ');
                        formattedAddress = addressParts.slice(0, 3).join(', ');
                    }
                    if (!formattedAddress.toLowerCase().includes('cartagena')) {
                        formattedAddress += ', Cartagena';
                    }
                    const startInput = document.getElementById('startInput');
                    startInput.value = formattedAddress;
                    document.getElementById('info').textContent = `📍 Ubicación actual detectada automáticamente: ${formattedAddress}`;
                    map.setView([latitude, longitude], 16);
                    // Restaurar: crear el marcador de punto de partida directamente
                    if (window.startMarker) map.removeLayer(window.startMarker);
                    window.startMarker = L.marker([latitude, longitude], {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[32,32],iconAnchor:[16,32]})}).addTo(map).bindPopup('Punto de partida').openPopup();
                    mostrarDistanciaYTiempo();
                    startLocationTracking();
                }
            }
        } catch (error) {console.log('No se pudo actualizar automáticamente el punto de partida:', error);}
    }

    // Función para actualizar automáticamente el campo de punto de partida
    async function updateStartPointField(latitude, longitude) {
        try {
            // Obtener dirección detallada automáticamente
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1&zoom=18&accept-language=es`);
            const data = await response.json();
            
            if (data.display_name) {
                // Formatear la dirección de forma automática y legible
                let formattedAddress = '';
                
                // Construir dirección desde los componentes más específicos
                if (data.address) {
                    const addr = data.address;
                    
                    // Priorizar componentes específicos de la dirección
                    if (addr.road && addr.house_number) {
                        formattedAddress = `${addr.road} #${addr.house_number}`;
                    } else if (addr.road) {
                        formattedAddress = addr.road;
                    } else if (addr.neighbourhood) {
                        formattedAddress = addr.neighbourhood;
                    } else if (addr.suburb) {
                        formattedAddress = addr.suburb;
                    }
                    
                    // Agregar barrio o sector si existe
                    if (addr.neighbourhood && !formattedAddress.includes(addr.neighbourhood)) {
                        formattedAddress += `, ${addr.neighbourhood}`;
                    } else if (addr.suburb && !formattedAddress.includes(addr.suburb)) {
                        formattedAddress += `, ${addr.suburb}`;
                    }
                    
                    // Agregar sector o zona
                    if (addr.city_district && !formattedAddress.includes(addr.city_district)) {
                        formattedAddress += `, ${addr.city_district}`;
                    }
                }
                
                // Si no se pudo construir una dirección específica, usar la display_name
                if (!formattedAddress) {
                    const addressParts = data.display_name.split(', ');
                    // Tomar solo las primeras 3 partes para hacerlo más legible
                    formattedAddress = addressParts.slice(0, 3).join(', ');
                }
                
                // Asegurar que termine con "Cartagena"
                if (!formattedAddress.toLowerCase().includes('cartagena')) {
                    formattedAddress += ', Cartagena';
                }
                
                // Actualizar el campo de entrada automáticamente
                const startInput = document.getElementById('startInput');
                startInput.value = formattedAddress;
                
                // Mostrar mensaje de confirmación automática
                document.getElementById('info').textContent = `📍 Ubicación actual detectada automáticamente: ${formattedAddress}`;
                
                // Iniciar seguimiento de ubicación automáticamente
                if (!watchId) {
                    startLocationTracking();
                }
            }
        } catch (error) {
            console.log('No se pudo actualizar automáticamente el campo de punto de partida:', error);
            // No mostrar error al usuario, es normal que no funcione en algunos casos
        }
    }

    // --- NUEVO: Mostrar distancia y tiempo ---
    function mostrarDistanciaYTiempo() {
        const infoBox = document.getElementById('distanceTimeBox');
        if (!window.startMarker || !window.endMarker) {
            infoBox.textContent = '';
            return;
        }
        const start = window.startMarker.getLatLng();
        const end = window.endMarker.getLatLng();
        const distancia = map.distance(start, end) / 1000; // en km
        const velocidadPromedio = 25; // km/h (urbano)
        const tiempoHoras = distancia / velocidadPromedio;
        const tiempoMin = Math.round(tiempoHoras * 60);
        infoBox.innerHTML = `<b>Distancia:</b> ${distancia.toFixed(2)} km<br><b>Tiempo estimado:</b> ${tiempoMin} min`;
    }

    // --- MODIFICAR: Crear marcador de punto de partida automáticamente al cargar la página ---
    async function autoUpdateStartPoint() {
        try {
            const position = await getCurrentPosition();
            const { latitude, longitude } = position.coords;
            const isInCartagena = latitude >= 10.3 && latitude <= 10.5 && longitude >= -75.6 && longitude <= -75.4;
            if (isInCartagena) {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1&zoom=18&accept-language=es`);
                const data = await response.json();
                if (data.display_name) {
                    let formattedAddress = '';
                    if (data.address) {
                        const addr = data.address;
                        if (addr.road && addr.house_number) {
                            formattedAddress = `${addr.road} #${addr.house_number}`;
                        } else if (addr.road) {
                            formattedAddress = addr.road;
                        } else if (addr.neighbourhood) {
                            formattedAddress = addr.neighbourhood;
                        } else if (addr.suburb) {
                            formattedAddress = addr.suburb;
                        }
                        if (addr.neighbourhood && !formattedAddress.includes(addr.neighbourhood)) {
                            formattedAddress += `, ${addr.neighbourhood}`;
                        } else if (addr.suburb && !formattedAddress.includes(addr.suburb)) {
                            formattedAddress += `, ${addr.suburb}`;
                        }
                        if (addr.city_district && !formattedAddress.includes(addr.city_district)) {
                            formattedAddress += `, ${addr.city_district}`;
                        }
                    }
                    if (!formattedAddress) {
                        const addressParts = data.display_name.split(', ');
                        formattedAddress = addressParts.slice(0, 3).join(', ');
                    }
                    if (!formattedAddress.toLowerCase().includes('cartagena')) {
                        formattedAddress += ', Cartagena';
                    }
                    const startInput = document.getElementById('startInput');
                    startInput.value = formattedAddress;
                    document.getElementById('info').textContent = `📍 Ubicación actual detectada automáticamente: ${formattedAddress}`;
                    map.setView([latitude, longitude], 16);
                    // --- Crear o actualizar marcador de punto de partida (startMarker) ---
                    if (window.startMarker) map.removeLayer(window.startMarker);
                    window.startMarker = L.marker([latitude, longitude], {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[32,32],iconAnchor:[16,32]})}).addTo(map).bindPopup('Punto de partida').openPopup();
                    mostrarDistanciaYTiempo();
                    startLocationTracking();
                }
            }
        } catch (error) {console.log('No se pudo actualizar automáticamente el punto de partida:', error);}
    }

    // --- MODIFICAR: Botón de ubicación actualiza marcador startMarker ---
    async function updateStartPointWithCurrentLocation() {
        const updateBtn = document.getElementById('updateLocationBtn');
        const startInput = document.getElementById('startInput');
        updateBtn.classList.add('loading');
        try {
            const position = await getCurrentPosition();
            const { latitude, longitude } = position.coords;
            const isInCartagena = latitude >= 10.3 && latitude <= 10.5 && longitude >= -75.6 && longitude <= -75.4;
            if (!isInCartagena) {alert('Tu ubicación actual está fuera de Cartagena.');updateBtn.classList.remove('loading');return;}
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1&zoom=18&accept-language=es`);
            const data = await response.json();
            if (data.display_name) {
                let formattedAddress = '';
                if (data.address) {
                    const addr = data.address;
                    if (addr.road && addr.house_number) {formattedAddress = `${addr.road} #${addr.house_number}`;}
                    else if (addr.road) {formattedAddress = addr.road;}
                    else if (addr.neighbourhood) {formattedAddress = addr.neighbourhood;}
                    else if (addr.suburb) {formattedAddress = addr.suburb;}
                    if (addr.neighbourhood && !formattedAddress.includes(addr.neighbourhood)) {formattedAddress += `, ${addr.neighbourhood}`;}
                    else if (addr.suburb && !formattedAddress.includes(addr.suburb)) {formattedAddress += `, ${addr.suburb}`;}
                    if (addr.city_district && !formattedAddress.includes(addr.city_district)) {formattedAddress += `, ${addr.city_district}`;}
                }
                if (!formattedAddress) {const addressParts = data.display_name.split(', ');formattedAddress = addressParts.slice(0, 3).join(', ');}
                if (!formattedAddress.toLowerCase().includes('cartagena')) {formattedAddress += ', Cartagena';}
                startInput.value = formattedAddress;
                document.getElementById('info').textContent = `📍 Ubicación actual detectada automáticamente: ${formattedAddress}`;
                map.setView([latitude, longitude], 16);
                if (userMarker) {userMarker.setLatLng([latitude, longitude]);userMarker.openPopup();}
                else {const userLocationIcon = L.divIcon({className: 'user-location-icon',html: '<div style="background: #ff6600; color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: bold; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3);">U</div>',iconSize: [16, 16],iconAnchor: [8, 8]});userMarker = L.marker([latitude, longitude], {icon: userLocationIcon}).addTo(map).bindPopup('📍 Tu ubicación actual en Cartagena').openPopup();}
                // Restaurar: crear el marcador de punto de partida directamente
                if (window.startMarker) map.removeLayer(window.startMarker);
                window.startMarker = L.marker([latitude, longitude], {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[32,32],iconAnchor:[16,32]})}).addTo(map).bindPopup('Punto de partida').openPopup();
                mostrarDistanciaYTiempo();
                if (!watchId) {startLocationTracking();}
                const startSuggestions = document.getElementById('startSuggestions');
                if (startSuggestions) {startSuggestions.innerHTML = '';startSuggestions.style.display = 'none';}
            } else {throw new Error('No se pudo obtener la dirección automáticamente');}
        } catch (error) {console.error('Error obteniendo ubicación actual automáticamente:', error);alert('No se pudo obtener tu ubicación actual automáticamente.');} finally {updateBtn.classList.remove('loading');}
    }

    // --- MODIFICAR: Cuando se selecciona destino, crear/actualizar endMarker y mostrar distancia/tiempo ---
    async function setEndMarkerFromInput(lat, lng, displayName) {
        if (window.endMarker) map.removeLayer(window.endMarker);
        window.endMarker = L.marker([lat, lng], {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684912.png',iconSize:[32,32],iconAnchor:[16,32]})}).addTo(map).bindPopup('Destino').openPopup();
        mostrarDistanciaYTiempo();
    }

    // --- AGREGAR: Mostrar estación/paradero más cercano al destino ---
    let nearestStationLine = null;
    function mostrarEstacionCercanaADestino(destLatLng) {
        if (!destLatLng) return;
        let minDist = Infinity;
        let nearest = null;
        estaciones.forEach(est => {
            const dist = map.distance(destLatLng, est.coords);
            if (dist < minDist) {
                minDist = dist;
                nearest = est;
            }
        });
        if (nearest) {
            // Resaltar marcador (opcional: podrías cambiar el icono o abrir el popup)
            // Buscar el marcador correspondiente (si los guardas en un array, mejor)
            // Dibujar línea
            if (nearestStationLine) map.removeLayer(nearestStationLine);
            nearestStationLine = L.polyline([destLatLng, nearest.coords], {color: '#ff6600', weight: 3, dashArray: '6,6'}).addTo(map);
            // Mostrar info
            const infoBox = document.getElementById('info');
            infoBox.innerHTML += `<br><b>Estación/paradero más cercano:</b> ${nearest.nombre} <br><b>Distancia:</b> ${minDist.toFixed(0)} m`;
            // Abrir popup de la estación
            L.popup()
                .setLatLng(nearest.coords)
                .setContent(`<b>${nearest.nombre}</b><br>Distancia: ${minDist.toFixed(0)} m`)
                .openOn(map);
        }
    }
    // Modificar searchLocation para llamar a mostrarEstacionCercanaADestino cuando se selecciona destino
    async function searchLocation(type) {
        const input = document.getElementById(type === 'start' ? 'startInput' : 'endInput');
        const query = input.value.trim();
        if (!query) return;
        const poiResults = await searchPOIs(query);
        const addressResults = await geocodeAddress(query);
        const results = [...poiResults, ...addressResults];
        if (!results.length) {
            document.getElementById('info').textContent = 'No se encontró la ubicación.';
            return;
        }
        const location = results[0];
        const latlng = [parseFloat(location.lat), parseFloat(location.lon)];
        if (type === 'start') {
            if (window.startMarker) map.removeLayer(window.startMarker);
            window.startMarker = L.marker(latlng, {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[32,32],iconAnchor:[16,32]})}).addTo(map).bindPopup('Punto de partida').openPopup();
            document.getElementById('info').textContent = `Punto de partida: ${location.displayName || location.display_name}`;
            mostrarDistanciaYTiempo();
        } else {
            await setEndMarkerFromInput(latlng[0], latlng[1], location.displayName || location.display_name);
            document.getElementById('info').textContent = `Destino: ${location.displayName || location.display_name}`;
            mostrarDistanciaYTiempo();
            mostrarEstacionCercanaADestino(latlng);
        }
        map.setView(latlng, 16);
    }
    // También llama a mostrarEstacionCercanaADestino cuando se selecciona destino en el mapa
    map.on('click', async function(e) {
        if (selecting === 'start') {
            if (window.startMarker) map.removeLayer(window.startMarker);
            window.startMarker = L.marker(e.latlng, {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[32,32],iconAnchor:[16,32]})}).addTo(map).bindPopup('Punto de partida').openPopup();
            selecting = null;
            const locationInfo = await getLocationInfo(e.latlng);
            document.getElementById('startInput').value = locationInfo;
            document.getElementById('info').textContent = 'Punto de partida seleccionado en el mapa.';
            mostrarDistanciaYTiempo();
        } else if (selecting === 'end') {
            if (window.endMarker) map.removeLayer(window.endMarker);
            window.endMarker = L.marker(e.latlng, {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684912.png',iconSize:[32,32],iconAnchor:[16,32]})}).addTo(map).bindPopup('Destino').openPopup();
            selecting = null;
            const locationInfo = await getLocationInfo(e.latlng);
            document.getElementById('endInput').value = locationInfo;
            document.getElementById('info').textContent = 'Destino seleccionado en el mapa.';
            mostrarDistanciaYTiempo();
            mostrarEstacionCercanaADestino([e.latlng.lat, e.latlng.lng]);
        }
    });

    // --- AGREGAR: Cuadro de distancia y tiempo ---
    const infoBoxDiv = document.createElement('div');
    infoBoxDiv.id = 'distanceTimeBox';
    infoBoxDiv.style = 'margin: 1rem auto 1rem auto; max-width: 400px; background: #f7f5ff; color: #4b2994; border-radius: 10px; box-shadow: 0 2px 8px rgba(107,70,193,0.08); padding: 1rem; text-align: center; font-size: 1.1rem; font-weight: 500; letter-spacing: 0.5px;';
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.querySelector('.search-container') || document.body;
        container.parentNode.insertBefore(infoBoxDiv, container.nextSibling);
    });

    // Agregar listeners para marcar automáticamente en el mapa los puntos al cambiar los inputs
    ['startInput', 'endInput'].forEach(function(id) {
        document.getElementById(id).addEventListener('change', function() {
            if (id === 'startInput') {
                searchLocation('start');
            } else {
                searchLocation('end');
            }
        });
    });
    </script>
</body>
</html> 