<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Guia - Te lleva</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            background: #f4f6fb;
        }
        header {
            background: #ff6600;
            color: #fff;
            padding: 1.5rem 0;
            text-align: center;
            font-size: 2rem;
            letter-spacing: 1px;
            font-weight: bold;
        }
        .search-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .search-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .search-info p {
            margin: 0;
            line-height: 1.4;
        }
        
        .category-selector {
            margin-bottom: 1.5rem;
        }
        
        .category-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .category-select:focus {
            outline: none;
            border-color: #6b46c1;
            box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.1);
        }
        
        .category-select option {
            padding: 0.5rem;
        }
        .search-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: flex-end;
        }
        .search-row .search-button {
            height: 48px;
            min-width: 110px;
            margin-bottom: 0;
            align-self: flex-end;
            font-size: 1rem;
            padding: 0 1.5rem;
            white-space: nowrap;
        }
        @media (max-width: 600px) {
            .search-row {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            .search-row .search-button {
                width: 100%;
                min-width: unset;
                height: 44px;
                margin-left: 0;
            }
        }
        .input-container {
            position: relative;
            flex: 1;
        }
        .search-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        .search-input:focus {
            outline: none;
            border-color: #6b46c1;
            box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.1);
        }
        .search-button {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #6b46c1, #553c9a);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 70, 193, 0.3);
        }
        .or-divider {
            text-align: center;
            margin: 1.5rem 0;
            color: #718096;
            font-weight: 500;
            position: relative;
        }
        .or-divider::before,
        .or-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #e2e8f0;
        }
        .or-divider::before {
            left: 0;
        }
        .or-divider::after {
            right: 0;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .btn-primary, .btn-secondary {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6b46c1, #553c9a);
            color: white;
        }
        .btn-secondary {
            background: white;
            color: #6b46c1;
            border: 2px solid #6b46c1;
        }
        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 70, 193, 0.2);
        }
        .info {
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(107, 70, 193, 0.1);
            border-radius: 12px;
            color: #553c9a;
            font-weight: 500;
        }
        .legend {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin: 2rem 0;
        }
        
        .legend h3 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .legend ul {
            list-style: none;
            padding: 0;
        }
        
        .legend li {
            margin-bottom: 0.5rem;
            color: #4a5568;
        }
        
        /* Estilos para contenedores lado a lado */
        .info-containers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .stats-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 16px;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .stats-container h3 {
            margin: 0 0 1.5rem 0;
            font-size: 1.5rem;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .stats-info {
            font-size: 0.9rem;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        @media (max-width: 768px) {
            .info-containers {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f7fafc;
            transition: background-color 0.2s ease;
        }
        .suggestion-item:hover {
            background-color: #f7fafc;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        #map {
            width: 100vw;
            height: 60vh;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin: 1.5rem 0;
        }
        .controls button {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #ff6600;
            color: #fff;
        }
        .btn-primary:hover {
            background: #e65c00;
        }
        .btn-secondary {
            background: #6c757d;
            color: #fff;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .info {
            text-align: center;
            margin-bottom: 1rem;
            color: #333;
            padding: 1rem;
            background: #fff;
            border-radius: 5px;
            margin: 1rem;
        }
        .legend {
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            max-width: 350px;
            margin: 2rem auto;
        }
        .legend h3 {
            margin-top: 0;
            color: #ff6600;
        }
        .legend ul {
            padding-left: 1.2rem;
        }
        .suggestions {
            position: absolute;
            background: #fff;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .suggestion-item {
            padding: 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .suggestion-item:hover {
            background: #f8f9fa;
        }
        .input-container {
            position: relative;
            flex: 1;
        }
        
        @media (max-width: 600px) {
            #map { height: 50vh; }
            .search-row { flex-direction: column; }
        }
        
        /* Estilos para la sección de rutas detalladas */
        .routes-detail-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 4rem 2rem;
            margin-top: 2rem;
        }
        
        .routes-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .routes-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 300;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        .routes-subtitle {
            text-align: center;
            color: #718096;
            font-size: 1.1rem;
            margin-bottom: 3rem;
        }
        
        .route-category {
            margin-bottom: 3rem;
        }
        
        .category-title {
            font-size: 1.8rem;
            font-weight: 400;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .route-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .route-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        .route-header {
            padding: 1.5rem;
            color: white;
        }
        
        .route-header h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.3rem;
            font-weight: 500;
        }
        
        .route-info {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .route-stations {
            padding: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        .station-item {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 400;
            color: white;
            transition: transform 0.2s ease;
        }
        
        .station-item:hover {
            transform: scale(1.05);
        }
        
        .station-item.portal {
            background: #ff6600;
        }
        
        .station-item.troncal {
            background: #0074D9;
        }
        
        .station-item.pretroncal {
            background: #2ECC40;
        }
        
        .station-item.alimentadora {
            background: #FF4136;
        }
        
        .station-item.complementaria {
            background: #FF851B;
        }
        
        .route-footer {
            padding: 1rem 1.5rem;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        .route-footer span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .routes-detail-section {
                padding: 2rem 1rem;
            }
            
            .routes-title {
                font-size: 2rem;
            }
            
            .route-stations {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .route-footer {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
        }
        
        .input-with-button {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .location-btn {
            position: absolute;
            right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .location-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .location-btn:active {
            transform: scale(0.95);
        }
        
        .location-btn.loading {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .search-input {
            padding-right: 60px;
        }
        #endInput {
            width: 100%;
            min-width: 180px;
            max-width: 100%;
            box-sizing: border-box;
        }
        @media (max-width: 600px) {
            .search-row {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            .search-row .input-container {
                max-width: 100%;
            }
            #endInput {
                max-width: 100%;
            }
        }
        
        /* Estilos para el vehículo en movimiento */
        .vehicle-marker {
            background: #ff6600;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            box-shadow: 0 0 8px rgba(255, 102, 0, 0.6);
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
        }
        
        .vehicle-marker.moving {
            background: #28a745;
            box-shadow: 0 0 12px rgba(40, 167, 69, 0.8);
            animation: pulse 1s infinite, bounce 0.8s infinite;
        }
        
        .vehicle-marker.stopped {
            background: #ff6600;
            box-shadow: 0 0 8px rgba(255, 102, 0, 0.6);
            animation: pulse 3s infinite;
        }
        
        .vehicle-marker::before {
            content: '🚗';
            font-size: 12px;
            animation: bounce 1s infinite;
        }
        
        .vehicle-marker.moving::before {
            animation: bounce 0.8s infinite;
        }
        
        .vehicle-marker.stopped::before {
            animation: none;
        }
        
        /* Estilos para la ruta en tiempo real */
        .realtime-route {
            stroke: #ff6600;
            stroke-width: 4;
            stroke-linecap: round;
            stroke-dasharray: 8, 4;
            animation: dash 2s linear infinite;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: -12;
            }
        }
        
        /* Panel de control de la ruta */
        .route-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 200px;
        }
        
        .route-controls h4 {
            margin: 0 0 0.5rem 0;
            color: #333;
            font-size: 0.9rem;
        }
        
        .route-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .route-stat {
            text-align: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.8rem;
        }
        
        .route-stat .value {
            font-weight: bold;
            color: #ff6600;
        }
        
        .route-controls button {
            width: 100%;
            padding: 0.5rem;
            margin: 0.25rem 0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .btn-play {
            background: #28a745;
            color: white;
        }
        
        .btn-pause {
            background: #ffc107;
            color: #333;
        }
        
        .btn-stop {
            background: #dc3545;
            color: white;
        }
        
        .btn-play:hover { background: #218838; }
        .btn-pause:hover { background: #e0a800; }
        .btn-stop:hover { background: #c82333; }
        
        /* Indicador de progreso */
        .progress-indicator {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6600, #ff8533);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Estilos para el modo de seguimiento */
        .tracking-mode {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 102, 0, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 1000;
            display: none;
        }
        
        .tracking-mode.active {
            display: block;
            animation: fadeInOut 2s infinite;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        /* Estilos para el panel de control automático */
        .route-controls {
            background: rgba(255,255,255,0.95) !important;
            color: #222 !important;
            border: 2px solid #bbb !important;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            margin: 1rem auto;
            max-width: 500px;
            text-align: center;
        }
        
        .route-controls h4 {
            margin: 0 0 1rem 0;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .route-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .route-stat {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .route-stat .value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .route-stat div:last-child {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .progress-indicator {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .auto-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: background 0.3s ease;
        }
        
        .status-indicator {
            font-size: 1.1rem;
            font-weight: 600;
            display: block;
            color: #ffcc00;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .auto-controls {
            display: flex;
            justify-content: center;
        }
        
        .btn-stop {
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-stop:hover {
            background: rgba(220, 53, 69, 1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        
        .tracking-mode {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            text-align: center;
            padding: 0.75rem;
            font-weight: 600;
            border-radius: 10px;
            margin: 1rem auto;
            max-width: 500px;
            display: none;
        }
        
        .tracking-mode.active {
            display: block;
        }
        
        /* Estilos para el sistema de botones de selección en mapa */
        .map-selection-toggle {
            background: linear-gradient(135deg, #6b46c1, #553c9a);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1rem auto;
            display: block;
        }
        
        .map-selection-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 70, 193, 0.3);
        }
        
        .map-selection-controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin: 1rem auto;
            max-width: 500px;
            text-align: center;
            display: none;
            backdrop-filter: blur(10px);
        }
        
        .map-selection-controls.active {
            display: block;
        }
        
        .map-selection-controls h4 {
            margin: 0 0 1rem 0;
            color: #333;
            font-size: 1.1rem;
        }
        
        .map-selection-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .map-selection-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .map-selection-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .map-selection-btn.active {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .map-selection-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(107, 70, 193, 0.1);
            border-radius: 8px;
            color: #553c9a;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        /* Estilos para la sección de rutas Transcaribe */
        .routes-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 4rem 2rem;
            margin-top: 2rem;
        }
        
        .routes-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .routes-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 300;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        .routes-subtitle {
            text-align: center;
            color: #718096;
            font-size: 1.1rem;
            margin-bottom: 3rem;
        }
        
        .route-category {
            margin-bottom: 3rem;
        }
        
        .category-title {
            font-size: 1.8rem;
            font-weight: 400;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .routes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        .route-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .route-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        .route-header {
            padding: 1.5rem;
            color: white;
        }
        
        .route-header h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.3rem;
            font-weight: 500;
        }
        
        .route-info {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .route-stations {
            padding: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        .station-item {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 400;
            color: white;
            transition: transform 0.2s ease;
        }
        
        .station-item:hover {
            transform: scale(1.05);
        }
        
        .station-item.portal {
            background: #ff6600;
        }
        
        .station-item.troncal {
            background: #0074D9;
        }
        
        .station-item.pretroncal {
            background: #2ECC40;
        }
        
        .station-item.alimentadora {
            background: #FF4136;
        }
        
        .station-item.complementaria {
            background: #FF851B;
        }
        
        @media (max-width: 768px) {
            .routes-section {
                padding: 2rem 1rem;
            }
            
            .routes-title {
                font-size: 2rem;
            }
            
            .routes-grid {
                grid-template-columns: 1fr;
            }
            
            .route-stations {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
        /* Agregar estilos para las etiquetas de estación */
        .estacion-label {
            background: #fff;
            color: #ff6600;
            font-weight: bold;
            border-radius: 6px;
            border: 1px solid #ff6600;
            padding: 2px 8px;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
    </style>
    <audio id="proximityAlarm" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae5c3.mp3" preload="auto" loop style="display:none"></audio>
</head>
<body>
    <header id="headerTitle">Mi Ruta - Cartagena</header>
    
    <!-- Panel de control de ruta en tiempo real -->
    <div class="route-controls" id="routeControls" style="display: none;">
        <h4>🚗 Seguimiento Automático</h4>
        <div class="route-stats">
            <div class="route-stat">
                <div class="value" id="distanceTraveled">0.0</div>
                <div>km recorridos</div>
            </div>
            <div class="route-stat">
                <div class="value" id="timeElapsed">00:00</div>
                <div>tiempo</div>
            </div>
            <div class="route-stat">
                <div class="value" id="currentSpeed">0.0</div>
                <div>km/h</div>
            </div>
        </div>
        <div class="progress-indicator">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="auto-status" id="autoStatus">
            <span class="status-indicator" id="statusIndicator">⏸️ Esperando movimiento</span>
        </div>
        <div class="auto-controls">
            <button class="btn-stop" id="stopRoute">⏹️ Detener seguimiento</button>
        </div>
    </div>
    
    <!-- Indicador de modo de seguimiento -->
    <div class="tracking-mode" id="trackingMode">
        🚗 Seguimiento en tiempo real activo
    </div>
    
    <div class="search-container">
        <div class="search-info">
            <p><strong>🌍 Área de Cobertura:</strong> Este sistema está optimizado para Cartagena de Indias. Las búsquedas y rutas están limitadas al área metropolitana de la ciudad.</p>
        </div>
        
        <div class="search-controls">
            <h3 style="text-align: center; color: #333; margin-bottom: 1.5rem; font-size: 1.3rem;">Planifica tu Ruta</h3>
            
            <!-- Selector de categorías -->
            <div class="category-selector">
                <label for="searchCategory" style="display: block; margin-bottom: 0.5rem; color: #666; font-size: 0.9rem;">Tipo de búsqueda:</label>
                <select id="searchCategory" class="category-select" onchange="updateSearchPlaceholders()">
                    <option value="all">🔍 Todo (direcciones, restaurantes, hoteles, etc.)</option>
                    <option value="restaurants">🍽️ Restaurantes y Cafés</option>
                    <option value="hotels">🏨 Hoteles y Alojamiento</option>
                    <option value="shops">🛒 Tiendas y Comercios</option>
                    <option value="businesses">🏢 Empresas y Negocios</option>
                    <option value="entertainment">🎭 Entretenimiento</option>
                    <option value="healthcare">🏥 Salud y Farmacias</option>
                    <option value="education">🎓 Educación</option>
                    <option value="transport">🚌 Transporte</option>
                </select>
            </div>
            
            <div class="search-group">
                <label for="startInput" style="display: block; margin-bottom: 0.5rem; color: #6b46c1; font-size: 0.95rem; font-weight: 600;">Punto de partida</label>
                <div class="input-with-button">
                    <input type="text" id="startInput" class="search-input" placeholder="Escribe tu punto de partida...">
                    <button id="updateLocationBtn" class="location-btn" title="Usar ubicación actual">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
                <div id="startSuggestions" class="suggestions"></div>
            </div>
            
            <div class="search-row">
                <div class="input-container" style="flex: 1;">
                    <label for="endInput" style="display: block; margin-bottom: 0.5rem; color: #6b46c1; font-size: 0.95rem; font-weight: 600;">Punto Destino</label>
                    <input type="text" id="endInput" class="search-input" placeholder="Escribe tu destino...">
                    <div id="endSuggestions" class="suggestions" style="display: none;"></div>
                </div>
                <button class="search-button" onclick="searchLocation('end')">Buscar</button>
            </div>
        </div>
    </div>
    
    <div class="controls" style="justify-content: center; gap: 1rem;">
        <button id="startRoute" class="btn-primary">Iniciar recorrido</button>
        <button id="clearRoute" class="btn-secondary">Limpiar ruta</button>
    </div>
    
    <div class="info" id="info">Escribe las direcciones, nombres de restaurantes, hoteles, tiendas o negocios, o selecciónalas en el mapa.</div>
    
    <button class="map-selection-toggle" id="toggleMapSelection">🗺️ Mostrar selección en mapa (origen/destino)</button>
    <div class="map-selection-controls" id="mapSelectionControls" style="display: none !important;">
        <h4>Selecciona en el mapa</h4>
        <div class="map-selection-buttons">
            <button id="setStart" class="map-selection-btn">Seleccionar en mapa (Origen)</button>
            <button id="setEnd" class="map-selection-btn">Seleccionar en mapa (Destino)</button>
        </div>
        <div class="map-selection-info">Haz clic en el botón y luego selecciona el punto en el mapa.</div>
    </div>
    
    <div id="map" style="width:100vw; height:60vh; min-height:300px;"></div>

    <!-- Sección RUTAS_TRANSCARIBE -->
    <section id="RUTAS_TRANSCARIBE" class="routes-section">
        <div class="routes-container">
            <h2 class="routes-title">🚌 Rutas Transcaribe</h2>
            <p class="routes-subtitle">Sistema Integrado de Transporte Masivo de Cartagena</p>
            
            <!-- Rutas Troncales -->
            <div class="route-category">
                <h3 class="category-title">🟠 Rutas Troncales</h3>
                <div class="routes-grid">
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #ff6600, #ff8533);">
                            <h4>T100E</h4>
                            <div class="route-info">PATIO PORTAL - CENTRO</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item troncal">MUELLE DE LA BODEGUITA</span>
                            <span class="station-item troncal">CENTRO UNO</span>
                            <span class="station-item troncal">MARIA AUXILIADORA</span>
                            <span class="station-item troncal">CUATRO VIENTOS</span>
                            <span class="station-item troncal">LA CASTELLANA</span>
                            <span class="station-item troncal">MADRE BERNARDA</span>
                            <span class="station-item troncal">PATIO PORTAL</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #ff6600, #ff8533);">
                            <h4>T101</h4>
                            <div class="route-info">PATIO PORTAL - CENTRO</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item troncal">MUELLE DE LA BODEGUITA</span>
                            <span class="station-item troncal">CENTRO UNO</span>
                            <span class="station-item troncal">CHAMBACU</span>
                            <span class="station-item troncal">PIE DE LA POPA</span>
                            <span class="station-item troncal">MERCADO BAZURTO</span>
                            <span class="station-item troncal">EL PRADO</span>
                            <span class="station-item troncal">ESPAÑA</span>
                            <span class="station-item troncal">CUATRO VIENTOS</span>
                            <span class="station-item troncal">VILLA OLIMPICA</span>
                            <span class="station-item troncal">LOS EJECUTIVOS</span>
                            <span class="station-item troncal">LA CASTELLANA</span>
                            <span class="station-item troncal">MADRE BERNARDA</span>
                            <span class="station-item troncal">PATIO PORTAL</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #ff6600, #ff8533);">
                            <h4>T102</h4>
                            <div class="route-info">PATIO PORTAL - CRESPO</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item troncal">CENTRO UNO</span>
                            <span class="station-item troncal">CHAMBACU</span>
                            <span class="station-item troncal">MERCADO BAZURTO</span>
                            <span class="station-item troncal">EL PRADO</span>
                            <span class="station-item troncal">MARIA AUXILIADORA</span>
                            <span class="station-item troncal">REPUBLICA DEL LIBANO</span>
                            <span class="station-item troncal">VILLA OLIMPICA</span>
                            <span class="station-item troncal">LOS ANGELES</span>
                            <span class="station-item troncal">MADRE BERNARDA</span>
                            <span class="station-item troncal">PATIO PORTAL</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #ff6600, #ff8533);">
                            <h4>T103</h4>
                            <div class="route-info">PATIO PORTAL - BOCAGRANDE</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item troncal">MUELLE DE LA BODEGUITA</span>
                            <span class="station-item troncal">CHAMBACU</span>
                            <span class="station-item troncal">PIE DE LA POPA</span>
                            <span class="station-item troncal">MERCADO BAZURTO</span>
                            <span class="station-item troncal">ESPAÑA</span>
                            <span class="station-item troncal">CUATRO VIENTOS</span>
                            <span class="station-item troncal">LOS EJECUTIVOS</span>
                            <span class="station-item troncal">LOS ANGELES</span>
                            <span class="station-item troncal">LA CASTELLANA</span>
                            <span class="station-item troncal">MADRE BERNARDA</span>
                            <span class="station-item troncal">PATIO PORTAL</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rutas Pretroncales -->
            <div class="route-category">
                <h3 class="category-title">🟢 Rutas Pretroncales</h3>
                <div class="routes-grid">
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #2ECC40, #27AE60);">
                            <h4>X101</h4>
                            <div class="route-info">SAN JOSE DE LOS CAMPANOS - 13 DE JUNIO - CENTRO</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item pretroncal">MUELLE DE LA BODEGUITA</span>
                            <span class="station-item pretroncal">CENTRO UNO</span>
                            <span class="station-item pretroncal">CHAMBACU</span>
                            <span class="station-item pretroncal">MERCADO BAZURTO</span>
                            <span class="station-item pretroncal">MARIA AUXILIADORA</span>
                            <span class="station-item pretroncal">ESPAÑA</span>
                            <span class="station-item pretroncal">REPUBLICA DEL LIBANO</span>
                            <span class="station-item pretroncal">CUATRO VIENTOS</span>
                            <span class="station-item pretroncal">VILLA OLIMPICA</span>
                            <span class="station-item pretroncal">LOS EJECUTIVOS</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #2ECC40, #27AE60);">
                            <h4>X102</h4>
                            <div class="route-info">PATIO PORTAL - BOSQUE - CENTRO</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item pretroncal">MUELLE DE LA BODEGUITA</span>
                            <span class="station-item pretroncal">CENTRO UNO</span>
                            <span class="station-item pretroncal">LO AMADOR</span>
                            <span class="station-item pretroncal">LAS DELICIAS</span>
                            <span class="station-item pretroncal">MERCADO BAZURTO</span>
                            <span class="station-item pretroncal">MADRE BERNARDA</span>
                            <span class="station-item pretroncal">PATIO PORTAL</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #2ECC40, #27AE60);">
                            <h4>X103</h4>
                            <div class="route-info">PATIO PORTAL - CONSULADO - CENTRO</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item pretroncal">MUELLE DE LA BODEGUITA</span>
                            <span class="station-item pretroncal">CENTRO UNO</span>
                            <span class="station-item pretroncal">LAS DELICIAS</span>
                            <span class="station-item pretroncal">MERCADO BAZURTO</span>
                            <span class="station-item pretroncal">EL PRADO</span>
                            <span class="station-item pretroncal">MADRE BERNARDA</span>
                            <span class="station-item pretroncal">PATIO PORTAL</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #2ECC40, #27AE60);">
                            <h4>X104</h4>
                            <div class="route-info">TERMINAL DE TRANSPORTE - PEDRO ROMERO - CENTRO</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item pretroncal">MUELLE DE LA BODEGUITA</span>
                            <span class="station-item pretroncal">CENTRO UNO</span>
                            <span class="station-item pretroncal">CHAMBACU</span>
                            <span class="station-item pretroncal">PIE DE LA POPA</span>
                            <span class="station-item pretroncal">MERCADO BAZURTO</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #2ECC40, #27AE60);">
                            <h4>X105</h4>
                            <div class="route-info">CIUDADELA 2000 - CRISANTO LUQUE - BOCAGRANDE</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item pretroncal">MUELLE DE LA BODEGUITA</span>
                            <span class="station-item pretroncal">CENTRO UNO</span>
                            <span class="station-item pretroncal">LO AMADOR</span>
                            <span class="station-item pretroncal">LAS DELICIAS</span>
                            <span class="station-item pretroncal">MERCADO BAZURTO</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #2ECC40, #27AE60);">
                            <h4>X106</h4>
                            <div class="route-info">VARIANTE - CENTRO</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item pretroncal">MUELLE DE LA BODEGUITA</span>
                            <span class="station-item pretroncal">CENTRO UNO</span>
                            <span class="station-item pretroncal">LO AMADOR</span>
                            <span class="station-item pretroncal">PIE DE LA POPA</span>
                            <span class="station-item pretroncal">LAS DELICIAS</span>
                            <span class="station-item pretroncal">MARIA AUXILIADORA</span>
                            <span class="station-item pretroncal">REPUBLICA DEL LIBANO</span>
                            <span class="station-item pretroncal">LOS EJECUTIVOS</span>
                            <span class="station-item pretroncal">LA CASTELLANA</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rutas Alimentadoras -->
            <div class="route-category">
                <h3 class="category-title">🔴 Rutas Alimentadoras</h3>
                <div class="routes-grid">
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #E74C3C);">
                            <h4>A101</h4>
                            <div class="route-info">CIUDAD JARDIN - PATIO PORTAL</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item alimentadora">PATIO PORTAL</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #E74C3C);">
                            <h4>A102</h4>
                            <div class="route-info">PATIO PORTAL - UNIVERSIDAD TECNOLOGICA DE BOLIVAR</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item alimentadora">PATIO PORTAL</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #E74C3C);">
                            <h4>A103</h4>
                            <div class="route-info">NELSON MANDELA - SAN FERNANDO - SANTA LUCIA</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item alimentadora">MADRE BERNARDA</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #E74C3C);">
                            <h4>A104</h4>
                            <div class="route-info">NELSON MANDELA - SOCORRO - SANTA LUCIA</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item alimentadora">MADRE BERNARDA</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #E74C3C);">
                            <h4>A105</h4>
                            <div class="route-info">SIMON BOLIVAR - SOCORRO - SANTA LUCIA</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item alimentadora">MADRE BERNARDA</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #E74C3C);">
                            <h4>A107</h4>
                            <div class="route-info">BLAS DE LEZO - SANTA LUCIA</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item alimentadora">MADRE BERNARDA</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #E74C3C);">
                            <h4>A108</h4>
                            <div class="route-info">CAMPESTRE - SANTA LUCIA</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item alimentadora">MADRE BERNARDA</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #E74C3C);">
                            <h4>A111</h4>
                            <div class="route-info">NUEVO BOSQUE - SANTA LUCIA</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item alimentadora">MADRE BERNARDA</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #E74C3C);">
                            <h4>A114</h4>
                            <div class="route-info">FLOR DEL CAMPO - PATIO PORTAL</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item alimentadora">PATIO PORTAL</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF4136, #E74C3C);">
                            <h4>A117</h4>
                            <div class="route-info">POZON - VILLA ESTRELLA - PORTAL</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item alimentadora">PATIO PORTAL</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rutas Complementarias -->
            <div class="route-category">
                <h3 class="category-title">🟡 Rutas Complementarias</h3>
                <div class="routes-grid">
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF851B, #FF6B35);">
                            <h4>C001</h4>
                            <div class="route-info">CIUDADELA 2000 - MANGA - CENTRO</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item complementaria">Ruta complementaria</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF851B, #FF6B35);">
                            <h4>C016</h4>
                            <div class="route-info">PATIO PORTAL - TERMINAL DE TRANSPORTE</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item complementaria">PATIO PORTAL</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF851B, #FF6B35);">
                            <h4>C017</h4>
                            <div class="route-info">MUELLE DE LA BODEGUITA - ZONA NORTE</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item complementaria">MUELLE DE LA BODEGUITA</span>
                            <span class="station-item complementaria">CENTRO UNO</span>
                        </div>
                    </div>
                    
                    <div class="route-card">
                        <div class="route-header" style="background: linear-gradient(135deg, #FF851B, #FF6B35);">
                            <h4>C018</h4>
                            <div class="route-info">MUELLE DE LA BODEGUITA - TORICES</div>
                        </div>
                        <div class="route-stations">
                            <span class="station-item complementaria">MUELLE DE LA BODEGUITA</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- GRILLA DE ESTACIONES Y DIRECCIONES CORRECTAS -->
    <section id="grilla-estaciones" style="margin: 3rem auto; max-width: 900px;">
        <h2 style="text-align:center; color:#ff6600;">🗺️ Estaciones Transcaribe y su Dirección Real</h2>
        <table style="width:100%; border-collapse:collapse; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.07);">
            <thead>
                <tr style="background:#ff6600; color:#fff;">
                    <th style="padding:1rem;">Estación</th>
                    <th style="padding:1rem;">Dirección</th>
                </tr>
            </thead>
            <tbody id="cuerpo-tabla-estaciones">
                <!-- Las filas se llenarán dinámicamente por JavaScript -->
            </tbody>
        </table>
    </section>
    <!-- FIN GRILLA ESTATICA -->

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    // Variables globales
    let map;
    let startMarker;
    let endMarker;
    let routeLine;
    let currentRoute = null;
    let isTracking = false;
    let trackingInterval;
    let startTime;
    let distanceTraveled = 0;
    let lastPosition = null;
    let vehicleMarker = null;
    let estaciones = [
      { "nombre": "PATIO PORTAL", "coords": [10.4066, -75.4757], "tipo": "portal", "descripcion": "Portal Patio Portal, Av. Pedro de Heredia" },
      { "nombre": "MADRE BERNARDA", "coords": [10.4091, -75.5106], "tipo": "portal", "descripcion": "Portal Madre Bernarda, Av. Pedro de Heredia" },
      { "nombre": "MUELLE DE LA BODEGUITA", "coords": [10.4225, -75.5477], "tipo": "portal", "descripcion": "Portal Muelle de la Bodeguita, Centro Histórico" },
      { "nombre": "LA CASTELLANA", "coords": [10.4112, -75.5417], "tipo": "troncal", "descripcion": "Estación La Castellana, barrio La Castellana" },
      { "nombre": "LOS ANGELES", "coords": [10.4132, -75.5447], "tipo": "troncal", "descripcion": "Estación Los Angeles, barrio Los Angeles" },
      { "nombre": "LOS EJECUTIVOS", "coords": [10.4150, -75.5469], "tipo": "troncal", "descripcion": "Estación Los Ejecutivos, barrio Los Ejecutivos" },
      { "nombre": "VILLA OLIMPICA", "coords": [10.4167, -75.5487], "tipo": "troncal", "descripcion": "Estación Villa Olímpica, barrio Villa Olímpica" },
      { "nombre": "CUATRO VIENTOS", "coords": [10.4182, -75.5505], "tipo": "troncal", "descripcion": "Estación Cuatro Vientos, sector Cuatro Vientos" },
      { "nombre": "REPUBLICA DEL LIBANO", "coords": [10.4197, -75.5527], "tipo": "troncal", "descripcion": "Estación República del Líbano, barrio República del Líbano" },
      { "nombre": "ESPAÑA", "coords": [10.4212, -75.5542], "tipo": "troncal", "descripcion": "Estación España, barrio España" },
      { "nombre": "EL PRADO", "coords": [10.4227, -75.5557], "tipo": "troncal", "descripcion": "Estación El Prado, barrio El Prado" },
      { "nombre": "MARIA AUXILIADORA", "coords": [10.4242, -75.5572], "tipo": "troncal", "descripcion": "Estación María Auxiliadora, barrio María Auxiliadora" },
      { "nombre": "MERCADO BAZURTO", "coords": [10.4106, -75.5141], "tipo": "troncal", "descripcion": "Estación Mercado Bazurto, sector Bazurto" },
      { "nombre": "PIE DE LA POPA", "coords": [10.4147, -75.5357], "tipo": "troncal", "descripcion": "Estación Pie de la Popa, barrio Pie de la Popa" },
      { "nombre": "CHAMBACU", "coords": [10.4270, -75.5450], "tipo": "troncal", "descripcion": "Estación Chambacú, barrio Chambacú" },
      { "nombre": "CENTRO UNO", "coords": [10.4237, -75.5469], "tipo": "troncal", "descripcion": "Estación Centro Uno, Centro Histórico" }
    ];
    window.estacionesCargadas = true;

    // === UNIFICACIÓN DE INICIALIZACIÓN ===
    // Eliminar todos los bloques document.addEventListener('DOMContentLoaded', ...) anteriores a este y fusionar aquí toda la lógica de inicialización.
    document.addEventListener('DOMContentLoaded', async function() {
        // Inicializar mapa
        try {
            map = L.map('map').setView([10.42312, -75.54802], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        } catch (e) {
            document.getElementById('info').textContent = 'Error al cargar el mapa: ' + e.message;
            return;
        }

        // Configurar event listeners para los botones
        const startRouteBtn = document.getElementById('startRoute');
        if (startRouteBtn) {
            startRouteBtn.addEventListener('click', startRoute);
        }
        const stopRouteBtn = document.getElementById('stopRoute');
        if (stopRouteBtn) {
            stopRouteBtn.addEventListener('click', stopRoute);
        }
        const clearRouteBtn = document.getElementById('clearRoute');
        if (clearRouteBtn) {
            clearRouteBtn.addEventListener('click', function() {
                // Remover marcadores
                if (startMarker) {
                    map.removeLayer(startMarker);
                    startMarker = null;
                }
                if (endMarker) {
                    map.removeLayer(endMarker);
                    endMarker = null;
                }
                if (vehicleMarker) {
                    map.removeLayer(vehicleMarker);
                    vehicleMarker = null;
                }
                if (routeLine) {
                    map.removeLayer(routeLine);
                    routeLine = null;
                }
                // Limpiar campos
                document.getElementById('startInput').value = '';
                document.getElementById('endInput').value = '';
                // Ocultar panel de control
                const routeControls = document.getElementById('routeControls');
                const trackingMode = document.getElementById('trackingMode');
                if (routeControls) routeControls.style.display = 'none';
                if (trackingMode) trackingMode.style.display = 'none';
                // Resetear seguimiento
                stopRoute();
                // Actualizar información
                document.getElementById('info').innerHTML = '🗺️ <strong>Ruta limpiada:</strong> Todos los puntos han sido eliminados.<br><br>💡 <em>Establece nuevos puntos de partida y destino</em>';
            });
        }

        // Configurar botón de rutas flotante
        const rutasBtn = document.createElement('button');
        rutasBtn.className = 'btn-primary';
        rutasBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1000; padding: 1rem 2rem; border-radius: 50px; box-shadow: 0 4px 20px rgba(255, 102, 0, 0.3);';
        rutasBtn.innerHTML = '🚌 RUTAS DE TRANSCARIBE';
        rutasBtn.onclick = () => {
            document.getElementById('RUTAS_TRANSCARIBE').scrollIntoView({ behavior: 'smooth' });
        };
        document.body.appendChild(rutasBtn);

        // Solicitar permiso de notificaciones
        if (window.Notification && Notification.permission !== 'granted') {
            Notification.requestPermission();
        }

        // Detectar ubicación automáticamente al cargar
        detectUserLocation();
        setTimeout(() => {
            if (!startMarker) {
                setDefaultStartMarker();
            }
        }, 3000);

        // Configurar funcionalidad de búsqueda y autocompletado
        // ... (mantener el bloque de autocompletado y selección en mapa tal como está)
        const toggleBtn = document.getElementById('toggleMapSelection');
        const controls = document.getElementById('mapSelectionControls');
        
        if (toggleBtn && controls) {
            let visible = false;
            controls.style.display = 'none';
            controls.classList.remove('active');
            
            toggleBtn.onclick = function() {
                visible = !visible;
                if (visible) {
                    controls.style.display = 'block';
                    controls.classList.add('active');
                    toggleBtn.textContent = '🗺️ Ocultar selección en mapa (origen/destino)';
                } else {
                    controls.style.display = 'none';
                    controls.classList.remove('active');
                    toggleBtn.textContent = '🗺️ Mostrar selección en mapa (origen/destino)';
                }
            };
        }

        // Configurar funcionalidad de búsqueda para campos de origen y destino
        const startInput = document.getElementById('startInput');
        const endInput = document.getElementById('endInput');
        const startSuggestions = document.getElementById('startSuggestions');
        const endSuggestions = document.getElementById('endSuggestions');

        // Event listeners para autocompletado
        if (startInput) {
            startInput.addEventListener('input', function() {
                if (this.value.length > 2) {
                    searchSuggestions(this.value, 'start');
                } else {
                    startSuggestions.style.display = 'none';
                }
            });

            startInput.addEventListener('focus', function() {
                if (this.value.length > 2) {
                    searchSuggestions(this.value, 'start');
                }
            });
        }

        if (endInput) {
            endInput.addEventListener('input', function() {
                if (this.value.length > 2) {
                    searchSuggestions(this.value, 'end');
                } else {
                    endSuggestions.style.display = 'none';
                }
            });

            endInput.addEventListener('focus', function() {
                if (this.value.length > 2) {
                    searchSuggestions(this.value, 'end');
                }
            });
        }

        // Ocultar sugerencias al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!startInput.contains(e.target) && !startSuggestions.contains(e.target)) {
                startSuggestions.style.display = 'none';
            }
            if (!endInput.contains(e.target) && !endSuggestions.contains(e.target)) {
                endSuggestions.style.display = 'none';
            }
        });
    });

    // Función para establecer marcador de punto de partida por defecto
    function setDefaultStartMarker() {
        if (startMarker) map.removeLayer(startMarker);
        startMarker = L.marker([10.42312, -75.54802], {
            icon: L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup('Punto de partida (Centro Cartagena)').openPopup();
        document.getElementById('startInput').value = 'Centro, Cartagena';
        updateStartPointInfo('Centro, Cartagena');
    }

    // Función para mostrar información de la ruta
    function showRouteInfo() {
        if (!window.estacionesCargadas) {
            document.getElementById('info').textContent = 'Cargando estaciones...';
            return;
        }
        if (!startMarker || !endMarker) return;
        
        const startLatLng = startMarker.getLatLng();
        let endLatLng = endMarker.getLatLng();
        
        console.log('=== INICIO showRouteInfo ===');
        console.log('Coordenadas de inicio:', startLatLng.lat, startLatLng.lng);
        console.log('Coordenadas de destino originales:', endLatLng.lat, endLatLng.lng);
        
        // Verificar si el destino es la Universidad Libre y usar coordenadas correctas
        const endInput = document.getElementById('endInput');
        if (endInput && endInput.value.toLowerCase().includes('universidad libre') && endInput.value.toLowerCase().includes('pie de la popa')) {
            // Usar coordenadas específicas para la Universidad Libre
            endLatLng = L.latLng(10.4140, -75.5330);
            console.log('Destino detectado como Universidad Libre, usando coordenadas corregidas:', endLatLng.lat, endLatLng.lng);
        }
        
        // Calcular distancia en línea recta
        const distance = startLatLng.distanceTo(endLatLng) / 1000; // en kilómetros
        
        // Calcular tiempo estimado (aproximadamente 30 km/h en ciudad)
        const estimatedTime = Math.round(distance / 30 * 60); // en minutos
        
        // Buscar las 3 estaciones más cercanas
        console.log('Buscando estaciones más cercanas al origen...');
        const nearestStartStations = findNearestStations(startLatLng, 3);
        console.log('Buscando estaciones más cercanas al destino...');
        const nearestEndStations = findNearestStations(endLatLng, 3);
        
        let infoText = `📍 <strong>Ruta establecida:</strong><br>`;
        infoText += `📏 Distancia: ${distance.toFixed(1)} km<br>`;
        infoText += `⏱️ Tiempo estimado: ${estimatedTime} min<br>`;
        
        if (nearestStartStations && nearestStartStations.length > 0) {
            infoText += `🚌 <strong>Estaciones más cercanas al origen:</strong><br>`;
            nearestStartStations.forEach((est, idx) => {
                infoText += `${idx+1}. <strong>${est.nombre}</strong> (${(est.distance/1000).toFixed(2)} km)<br>`;
            });
        }
        
        if (nearestEndStations && nearestEndStations.length > 0) {
            infoText += `🚌 <strong>Estaciones más cercanas al destino:</strong><br>`;
            nearestEndStations.forEach((est, idx) => {
                infoText += `${idx+1}. <strong>${est.nombre}</strong> (${(est.distance/1000).toFixed(2)} km)<br>`;
            });
        }
        
        infoText += `<br>💡 <em>Usa el botón "Iniciar recorrido" para comenzar la navegación</em>`;
        
        document.getElementById('info').innerHTML = infoText;
    }

    // Función para encontrar las 3 estaciones más cercanas
    function findNearestStations(latLng, count = 3) {
        if (!window.estacionesCargadas) {
            console.warn('Estaciones no cargadas aún');
            return [];
        }
        const estacionesConDistancia = estaciones
            .filter(estacion => estacion.coords && estacion.coords[0] && estacion.coords[1])
            .map(estacion => {
                const stationLatLng = L.latLng(estacion.coords[0], estacion.coords[1]);
                const distance = latLng.distanceTo(stationLatLng);
                return { ...estacion, distance };
            });
        estacionesConDistancia.sort((a, b) => a.distance - b.distance);
        return estacionesConDistancia.slice(0, count);
    }

    // Función para actualizar información cuando cambia el punto de partida
    function updateStartPointInfo(address) {
        if (endMarker) {
            showRouteInfo();
        } else {
            document.getElementById('info').innerHTML = `📍 <strong>Punto de partida establecido:</strong> ${address}<br><br>💡 <em>Ahora selecciona tu destino para ver la ruta</em>`;
        }
    }

    // Función para actualizar información cuando cambia el destino
    function updateEndPointInfo(address) {
        if (startMarker) {
            showRouteInfo();
        } else {
            document.getElementById('info').innerHTML = `🎯 <strong>Destino establecido:</strong> ${address}<br><br>💡 <em>Ahora selecciona tu punto de partida para ver la ruta</em>`;
        }
    }

    // Función para detectar ubicación del usuario
    function detectUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    if (startMarker) map.removeLayer(startMarker);
                    startMarker = L.marker([lat, lng], {
                        icon: L.icon({
                            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                            iconSize: [32, 32],
                            iconAnchor: [16, 32]
                        })
                    }).addTo(map).bindPopup('Tu ubicación actual').openPopup();
                    
                    map.setView([lat, lng], 15);
                    
                    // Obtener dirección real usando Nominatim
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.display_name) {
                                const address = data.display_name.split(',').slice(0, 3).join(', ');
                                document.getElementById('startInput').value = address;
                                updateStartPointInfo(address);
                            } else {
                                const coords = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                                document.getElementById('startInput').value = coords;
                                updateStartPointInfo(coords);
                            }
                        })
                        .catch(error => {
                            console.log('Error al obtener dirección:', error);
                            const coords = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                            document.getElementById('startInput').value = coords;
                            updateStartPointInfo(coords);
                        });
                },
                function(error) {
                    console.log('Error de geolocalización:', error);
                    setDefaultStartMarker();
                }
            );
        } else {
            setDefaultStartMarker();
        }
    }

    // Configurar botón de selección en mapa
    
    // Función para buscar sugerencias de direcciones
    async function searchSuggestions(query, type) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Cartagena, Colombia')}&limit=5&addressdetails=1`);
            const data = await response.json();
            
            const suggestionsDiv = type === 'start' ? document.getElementById('startSuggestions') : document.getElementById('endSuggestions');
            suggestionsDiv.innerHTML = '';
            
            if (data.length > 0) {
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = item.display_name.split(',').slice(0, 3).join(', ');
                    div.onclick = () => {
                        const input = type === 'start' ? document.getElementById('startInput') : document.getElementById('endInput');
                        const address = item.display_name.split(',').slice(0, 3).join(', ');
                        input.value = address;
                        suggestionsDiv.style.display = 'none';
                        
                        if (type === 'start') {
                            // Actualizar punto de partida
                            if (startMarker) map.removeLayer(startMarker);
                            startMarker = L.marker([item.lat, item.lon], {
                                icon: L.icon({
                                    iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                                    iconSize: [32, 32],
                                    iconAnchor: [16, 32]
                                })
                            }).addTo(map).bindPopup('Punto de partida: ' + address).openPopup();
                            
                            map.setView([item.lat, item.lon], 15);
                            updateStartPointInfo(address);
                        } else {
                            // Actualizar destino
                            placeEndMarker(item.lat, item.lon, address);
                        }
                    };
                    suggestionsDiv.appendChild(div);
                });
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        } catch (error) {
            console.error('Error al buscar sugerencias:', error);
        }
    }

    // Función para buscar ubicación específica
    async function searchLocation(type) {
        const input = type === 'start' ? document.getElementById('startInput') : document.getElementById('endInput');
        const query = input.value.trim();
        
        if (!query) {
            document.getElementById('info').textContent = 'Por favor, ingresa una dirección para buscar.';
            return;
        }

        try {
            document.getElementById('info').textContent = 'Buscando ubicación...';
            
            // Verificación especial para Universidad Libre
            let searchQuery = query + ', Cartagena, Colombia';
            if (query.toLowerCase().includes('universidad libre') && query.toLowerCase().includes('pie de la popa')) {
                // Usar coordenadas específicas para la Universidad Libre
                const unilibreCoords = [10.4140, -75.5330];
                console.log('Ubicación específica detectada: Universidad Libre, usando coordenadas:', unilibreCoords);
                
                if (type === 'start') {
                    if (startMarker) map.removeLayer(startMarker);
                    startMarker = L.marker(unilibreCoords, {
                        icon: L.icon({
                            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                            iconSize: [32, 32],
                            iconAnchor: [16, 32]
                        })
                    }).addTo(map).bindPopup('Punto de partida: Universidad Libre').openPopup();
                    
                    map.setView(unilibreCoords, 15);
                    input.value = 'Universidad Libre, Calle 30, Pie De La Popa';
                    updateStartPointInfo('Universidad Libre, Calle 30, Pie De La Popa');
                } else {
                    placeEndMarker(unilibreCoords[0], unilibreCoords[1], 'Universidad Libre, Calle 30, Pie De La Popa');
                    input.value = 'Universidad Libre, Calle 30, Pie De La Popa';
                    updateEndPointInfo('Universidad Libre, Calle 30, Pie De La Popa');
                }
                return;
            }
            
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1&addressdetails=1`);
            const data = await response.json();
            
            if (data.length > 0) {
                const item = data[0];
                const address = item.display_name.split(',').slice(0, 3).join(', ');
                
                console.log('Coordenadas obtenidas de Nominatim:', item.lat, item.lon, 'para:', address);
                
                if (type === 'start') {
                    // Actualizar punto de partida
                    if (startMarker) map.removeLayer(startMarker);
                    startMarker = L.marker([item.lat, item.lon], {
                        icon: L.icon({
                            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                            iconSize: [32, 32],
                            iconAnchor: [16, 32]
                        })
                    }).addTo(map).bindPopup('Punto de partida: ' + address).openPopup();
                    
                    map.setView([item.lat, item.lon], 15);
                    input.value = address;
                    updateStartPointInfo(address);
                } else {
                    // Actualizar destino
                    placeEndMarker(item.lat, item.lon, address);
                    input.value = address;
                    updateEndPointInfo(address);
                }
            } else {
                document.getElementById('info').textContent = 'No se encontró la ubicación. Intenta con una dirección más específica.';
            }
        } catch (error) {
            console.error('Error al buscar ubicación:', error);
            document.getElementById('info').textContent = 'Error al buscar la ubicación. Intenta de nuevo.';
        }
    }

    // Función para colocar marcador de destino
    function placeEndMarker(lat, lng, address) {
        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker([lat, lng], {
            icon: L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684909.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup('Destino: ' + address).openPopup();
        
        // Ajustar vista del mapa para mostrar ambos marcadores
        if (startMarker) {
            const bounds = L.latLngBounds([startMarker.getLatLng(), endMarker.getLatLng()]);
            map.fitBounds(bounds, { padding: [50, 50] });
            
            // Mostrar información de la ruta
            showRouteInfo();
        } else {
            map.setView([lat, lng], 15);
            updateEndPointInfo(address);
        }
    }

    // Función para iniciar el recorrido
    function startRoute() {
        if (!startMarker || !endMarker) {
            document.getElementById('info').innerHTML = '⚠️ <strong>Error:</strong> Debes establecer tanto el punto de partida como el destino antes de iniciar el recorrido.';
            return;
        }

        // Mostrar panel de control de ruta
        const routeControls = document.getElementById('routeControls');
        const trackingMode = document.getElementById('trackingMode');
        
        if (routeControls) routeControls.style.display = 'block';
        if (trackingMode) trackingMode.style.display = 'block';

        // Inicializar variables de seguimiento
        isTracking = true;
        startTime = Date.now();
        distanceTraveled = 0;
        
        // Crear marcador del vehículo
        const startLatLng = startMarker.getLatLng();
        vehicleMarker = L.marker(startLatLng, {
            icon: L.divIcon({
                className: 'vehicle-marker stopped',
                html: '<div style="background: #ff6600; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 0 8px rgba(255, 102, 0, 0.6);">🚗</div>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            })
        }).addTo(map);

        // Crear línea de ruta
        const endLatLng = endMarker.getLatLng();
        routeLine = L.polyline([startLatLng, endLatLng], {
            color: '#ff6600',
            weight: 4,
            opacity: 0.7,
            dashArray: '8, 4'
        }).addTo(map);

        // Iniciar seguimiento de ubicación
        if (navigator.geolocation) {
            trackingInterval = setInterval(trackLocation, 3000); // Actualizar cada 3 segundos
        }

        // Actualizar información
        document.getElementById('info').innerHTML = '🚗 <strong>Recorrido iniciado:</strong> El seguimiento en tiempo real está activo.<br><br>💡 <em>Usa los controles para gestionar el seguimiento</em>';
        
        // Actualizar estado inicial
        updateTrackingStatus('Detenido');
        updateTrackingStats();
    }

    // Función para rastrear la ubicación
    function trackLocation() {
        if (!isTracking) return;

        navigator.geolocation.getCurrentPosition(
            function(position) {
                const currentLat = position.coords.latitude;
                const currentLng = position.coords.longitude;
                const currentPosition = L.latLng(currentLat, currentLng);

                if (lastPosition) {
                    // Calcular distancia recorrida
                    const distance = lastPosition.distanceTo(currentPosition);
                    distanceTraveled += distance / 1000; // Convertir a kilómetros

                    // Determinar si está en movimiento (más de 5 metros en 3 segundos = ~6 km/h)
                    const isMoving = distance > 5;
                    updateTrackingStatus(isMoving ? 'En movimiento' : 'Detenido');
                    
                    // Actualizar marcador del vehículo
                    if (vehicleMarker) {
                        vehicleMarker.setLatLng(currentPosition);
                        const iconElement = vehicleMarker.getElement();
                        if (iconElement) {
                            const vehicleDiv = iconElement.querySelector('div');
                            if (vehicleDiv) {
                                vehicleDiv.className = isMoving ? 'vehicle-marker moving' : 'vehicle-marker stopped';
                                vehicleDiv.style.background = isMoving ? '#28a745' : '#ff6600';
                                vehicleDiv.style.boxShadow = isMoving ? '0 0 12px rgba(40, 167, 69, 0.8)' : '0 0 8px rgba(255, 102, 0, 0.6)';
                            }
                        }
                    }
                }

                lastPosition = currentPosition;
                updateTrackingStats();
                
                // Centrar mapa en la posición actual
                map.setView(currentPosition, 16);
            },
            function(error) {
                console.log('Error en seguimiento de ubicación:', error);
            }
        );
    }

    // Función para actualizar el estado del seguimiento
    function updateTrackingStatus(status) {
        const statusIndicator = document.getElementById('statusIndicator');
        if (statusIndicator) {
            if (status === 'En movimiento') {
                statusIndicator.textContent = '🚗 En movimiento';
                statusIndicator.style.color = '#28a745';
            } else {
                statusIndicator.textContent = '⏸️ Detenido';
                statusIndicator.style.color = '#ff6600';
            }
        }
    }

    // Función para actualizar estadísticas del seguimiento
    function updateTrackingStats() {
        const distanceElement = document.getElementById('distanceTraveled');
        const timeElement = document.getElementById('timeElapsed');
        const speedElement = document.getElementById('currentSpeed');
        const progressBar = document.getElementById('progressBar');

        if (distanceElement) {
            distanceElement.textContent = distanceTraveled.toFixed(1);
        }

        if (timeElement && startTime) {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            timeElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        if (speedElement && lastPosition) {
            // Calcular velocidad promedio (simplificado)
            const elapsedHours = (Date.now() - startTime) / (1000 * 60 * 60);
            const avgSpeed = elapsedHours > 0 ? distanceTraveled / elapsedHours : 0;
            speedElement.textContent = avgSpeed.toFixed(1);
        }

        // Actualizar barra de progreso
        if (progressBar && startMarker && endMarker) {
            const totalDistance = startMarker.getLatLng().distanceTo(endMarker.getLatLng()) / 1000;
            const progress = totalDistance > 0 ? Math.min((distanceTraveled / totalDistance) * 100, 100) : 0;
            progressBar.style.width = progress + '%';
        }
    }

    // Función para detener el seguimiento
    function stopRoute() {
        isTracking = false;
        
        if (trackingInterval) {
            clearInterval(trackingInterval);
            trackingInterval = null;
        }

        // Ocultar panel de control
        const routeControls = document.getElementById('routeControls');
        const trackingMode = document.getElementById('trackingMode');
        
        if (routeControls) routeControls.style.display = 'none';
        if (trackingMode) trackingMode.style.display = 'none';

        // Remover marcador del vehículo y línea de ruta
        if (vehicleMarker) {
            map.removeLayer(vehicleMarker);
            vehicleMarker = null;
        }
        
        if (routeLine) {
            map.removeLayer(routeLine);
            routeLine = null;
        }

        // Resetear variables
        lastPosition = null;
        distanceTraveled = 0;
        startTime = null;

        // Actualizar información
        document.getElementById('info').innerHTML = '🛑 <strong>Recorrido detenido:</strong> El seguimiento en tiempo real se ha detenido.<br><br>💡 <em>Puedes iniciar un nuevo recorrido cuando quieras</em>';
    }

    // --- GRILLA Y MARCADORES DE ESTACIONES CON DIRECCIÓN REAL ---
    const cuerpoTabla = document.getElementById('cuerpo-tabla-estaciones');
    if (window.estacionesLayerGroup) {
        map.removeLayer(window.estacionesLayerGroup);
    }
    window.estacionesLayerGroup = L.layerGroup();

    // Definir íconos personalizados para cada tipo
    const iconosEstacion = {
        portal: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
        }),
        troncal: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252025.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
        }),
        pretroncal: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252033.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
        }),
        complementaria: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252035.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
        })
    };

    // Función para obtener dirección real de una estación
    async function getDireccionEstacion(coords) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords[0]}&lon=${coords[1]}&zoom=18&addressdetails=1`);
            const data = await response.json();
            if (data.display_name) {
                return data.display_name;
            }
        } catch (e) {}
        return 'Dirección no disponible';
    }

    // Llenar la tabla y poner los marcadores
    async function cargarEstacionesYDirecciones() {
        cuerpoTabla.innerHTML = '';
        for (const estacion of estaciones) {
            if (estacion.coords[0] && estacion.coords[1]) {
                // Solo agregar fila a la tabla, NO agregar marcador al mapa
                const direccion = await getDireccionEstacion(estacion.coords);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style='padding:0.7rem 1rem;'>${estacion.nombre}</td><td style='padding:0.7rem 1rem;'>${direccion}</td>`;
                cuerpoTabla.appendChild(tr);
            }
        }
        // NO agregar window.estacionesLayerGroup al mapa
    }
    </script>
</body>
</html> 